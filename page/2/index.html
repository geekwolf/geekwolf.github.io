<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Geekwolf,DevOps,Docker,k8s,MySQL,PaaS" />





  <link rel="alternate" href="/atom.xml" title="Geekwolf's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="DevOps | Docker | Python | k8s">
<meta property="og:type" content="website">
<meta property="og:title" content="Geekwolf&#39;s Blog">
<meta property="og:url" content="http://www.simlinux.com/page/2/index.html">
<meta property="og:site_name" content="Geekwolf&#39;s Blog">
<meta property="og:description" content="DevOps | Docker | Python | k8s">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Geekwolf&#39;s Blog">
<meta name="twitter:description" content="DevOps | Docker | Python | k8s">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.simlinux.com/page/2/"/>





  <title>Geekwolf's Blog</title>
  












  <div style="display: none;">
    <script src="//s13.cnzz.com/z_stat.php?id=1264375041&web_id=1264375041" language="JavaScript"></script>
  </div>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Geekwolf's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Quick notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tips">
          <a href="/tips/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gittip"></i> <br />
            
            tips
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2017/02/28/net-softirq.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/28/net-softirq.html" itemprop="url">网卡软中断过高问题优化总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-28T19:06:50+08:00">
                2017-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux运维/" itemprop="url" rel="index">
                    <span itemprop="name">Linux运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/02/28/net-softirq.html" class="leancloud_visitors" data-flag-title="网卡软中断过高问题优化总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  26
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h4 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h4><p>游戏网关高峰期时出网络丢包,CPU0软中断%sys高达90%</p>
<h4 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h4><h5 id="什么是中断"><a href="#什么是中断" class="headerlink" title="什么是中断?"></a>什么是中断?</h5><p>由于接收来自外围硬件(相对于CPU和内存)的异步信号或者来自软件的同步信号，而进行相应的硬件、软件处理；发出这样的信号称为进行中断请求(interrupt request, IRQ)</p>
<h5 id="硬中断与软中断"><a href="#硬中断与软中断" class="headerlink" title="硬中断与软中断?"></a>硬中断与软中断?</h5><ul>
<li><strong>硬中断</strong>：外围硬件发给CPU或者内存的异步信号就称之为硬中断</li>
<li><strong>软中断</strong>：由软件系统本身发给操作系统内核的中断信号，称之为软中断。通常是由硬中断处理程序或进程调度程序对操作系统内核的中断，也就是我们常说的系统调用(System Call)</li>
</ul>
<h5 id="硬中断与软中断之区别与联系？"><a href="#硬中断与软中断之区别与联系？" class="headerlink" title="硬中断与软中断之区别与联系？"></a>硬中断与软中断之区别与联系？</h5><ol>
<li>硬中断是有外设硬件发出的，需要有中断控制器之参与。其过程是外设侦测到变化，告知中断控制器，中断控制器通过CPU或内存的中断脚通知CPU，然后硬件进行程序计数器及堆栈寄存器之现场保存工作（引发上下文切换），并根据中断向量调用硬中断处理程序进行中断处理</li>
<li>软中断则通常是由硬中断处理程序或者进程调度程序等软件程序发出的中断信号，无需中断控制器之参与，直接以一个CPU指令之形式指示CPU进行程序计数器及堆栈寄存器之现场保存工作(亦会引发上下文切换)，并调用相应的软中断处理程序进行中断处理(即我们通常所言之系统调用)</li>
<li>硬中断直接以硬件的方式引发，处理速度快。软中断以软件指令之方式适合于对响应速度要求不是特别严格的场景</li>
<li>硬中断通过设置CPU的屏蔽位可进行屏蔽，软中断则由于是指令之方式给出，不能屏蔽</li>
<li>硬中断发生后，通常会在硬中断处理程序中调用一个软中断来进行后续工作的处理</li>
<li>硬中断和软中断均会引起上下文切换(进程/线程之切换)，进程切换的过程是差不多的</li>
</ol>
<h4 id="查看中断情况"><a href="#查看中断情况" class="headerlink" title="查看中断情况"></a>查看中断情况</h4><p><strong>查看中断分布情况即CPU都在哪些设备上干活，干了多少(也可以使用itop工具实时查看)？</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">root@geekwolf:~# cat /proc/interrupts</div><div class="line"></div><div class="line">           CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       CPU8       CPU9       CPU10      CPU11      CPU12      CPU13      CPU14      CPU15      CPU16      CPU17      CPU18      CPU19      CPU20      CPU21      CPU22      CPU23      CPU24      CPU25      CPU26      CPU27      CPU28      CPU29      CPU30      CPU31      </div><div class="line">  0:        620          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-IO-APIC-edge      timer</div><div class="line">  8:          1          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-IO-APIC-edge      rtc0</div><div class="line">  9:      20774          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-IO-APIC-fasteoi   acpi</div><div class="line"> 16:         28          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-IO-APIC-fasteoi   ehci_hcd:usb1</div><div class="line"> 23:        243          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-IO-APIC-fasteoi   ehci_hcd:usb2</div><div class="line"> 88:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  DMAR_MSI-edge      dmar0</div><div class="line"> 89:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  DMAR_MSI-edge      dmar1</div><div class="line"> 90:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 91:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 92:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 93:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 94:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 95:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 96:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 97:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 98:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line"> 99:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line">100:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      PCIe PME</div><div class="line">101:     169988          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      mpt2sas0-msix0</div><div class="line">134:    1900138          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth2-q0</div><div class="line">150:    4262209          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth3-q0</div><div class="line">166:          4          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">167:          4          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">168:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">169:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">170:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">171:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">172:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">173:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">174:          4          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">175:          4          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">176:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">177:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">178:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">179:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">180:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">181:          2          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ioat-msix</div><div class="line">NMI:        710        280        658        235        114         91         76         74        208        123        176        128        106         93        102         95         30        360        790         46         28         17         10          8         10        129       1166         22         18         16         11          7   Non-maskable interrupts</div><div class="line">LOC:    4230314    2640664    2427443    1337890    1091372     892129     819153     816781    2695809    1563153    1368637    1608410    1241692    1166692    1205270    1124865     120831    1966946     328048     816162     163492     222276     129805     121126     111906     599782    1247371     194215     162828     145678     118762     114295   Local timer interrupts</div><div class="line">SPU:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0   Spurious interrupts</div><div class="line">PMI:        710        280        658        235        114         91         76         74        208        123        176        128        106         93        102         95         30        360        790         46         28         17         10          8         10        129       1166         22         18         16         11          7   Performance monitoring interrupts</div><div class="line">IWI:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0   IRQ work interrupts</div><div class="line">RES:     679921    1369165    1013002     573776     543083     540027     593345     588120     842115     846190     874862     890102     873810     860080     867322     848916       3879      63916      10863      12850       7463       6350      10889      16041       2065      13207       6870       6817       4030       4700       5190       7430   Rescheduling interrupts</div><div class="line">CAL:      46507      67439      67569      67567      67565      67566      67566      67568     154689      67553      67511      67538      67568      67557      67534      67519      67520      26471      67470      67470      67476      67525      67518      67525      67545      64065      67210      67506      67485      67492      67526      67521   Function call interrupts</div><div class="line">TLB:       6547       3416       1798       1015        361        637        271        447        822        113       1079        222        259        198        265        844        157       1470       3468        767        499        262        338        230         41       1457       4023        290        105         93         46        177   TLB shootdowns</div><div class="line">TRM:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0   Thermal event interrupts</div><div class="line">THR:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0   Threshold APIC interrupts</div><div class="line">MCE:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0   Machine check exceptions</div><div class="line">MCP:        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569        569   Machine check polls</div><div class="line">ERR:          0</div><div class="line">MIS:          0</div></pre></td></tr></table></figure></p>
<p>从上面的数据可以看出网卡eth2、eth3软中断都落在CPU0可以通过cat /proc/softirqs查看具体的软中断情况,总的中断次数可以通过vmstat或者dstat查看，其中vmstat中的in表示每秒的中断次数；<br>通过mpstat -P ALL 2,每隔两秒查看下所有核状态信息，其中%irq为硬中断，%soft为软中断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">root@geekwolf:~# mpstat -P ALL 2</div><div class="line">08:42:04 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle</div><div class="line">08:42:05 AM  all    4.31    0.00    0.70    0.00    0.00    0.06    0.00    0.00   94.93</div><div class="line">08:42:05 AM    0    5.26    0.00    1.05    0.00    0.00    60.05    0.00    0.00   92.63</div><div class="line">08:42:05 AM    1    7.07    0.00    1.01    0.00    0.00    0.00    0.00    0.00   91.92</div><div class="line">08:42:05 AM    2    8.91    0.00    0.99    0.00    0.00    0.00    0.00    0.00   90.10</div><div class="line">08:42:05 AM    3    8.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   91.00</div><div class="line">08:42:05 AM    4    8.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   91.00</div><div class="line">08:42:05 AM    5    7.00    0.00    2.00    0.00    0.00    0.00    0.00    0.00   91.00</div><div class="line">08:42:05 AM    6    7.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   92.00</div><div class="line">08:42:05 AM    7    4.12    0.00    1.03    0.00    0.00    0.00    0.00    0.00   94.85</div><div class="line">08:42:05 AM    8    4.17    0.00    1.04    0.00    0.00    0.00    0.00    0.00   94.79</div><div class="line">08:42:05 AM    9    8.91    0.00    0.99    0.00    0.00    0.00    0.00    0.00   90.10</div><div class="line">08:42:05 AM   10    4.17    0.00    2.08    0.00    0.00    0.00    0.00    0.00   93.75</div><div class="line">08:42:05 AM   11    6.12    0.00    1.02    0.00    0.00    0.00    0.00    0.00   92.86</div><div class="line">08:42:05 AM   12    6.00    0.00    2.00    0.00    0.00    0.00    0.00    0.00   92.00</div><div class="line">08:42:05 AM   13    3.16    0.00    1.05    0.00    0.00    0.00    0.00    0.00   95.79</div><div class="line">08:42:05 AM   14    8.16    0.00    1.02    0.00    0.00    0.00    0.00    0.00   90.82</div><div class="line">08:42:05 AM   15    6.06    0.00    1.01    0.00    0.00    1.01    0.00    0.00   91.92</div><div class="line">08:42:05 AM   16    3.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   96.00</div><div class="line">08:42:05 AM   17    2.02    0.00    1.01    0.00    0.00    0.00    0.00    0.00   96.97</div><div class="line">08:42:05 AM   18    2.04    0.00    1.02    0.00    0.00    0.00    0.00    0.00   96.94</div><div class="line">08:42:05 AM   19    2.97    0.00    0.99    0.00    0.00    0.00    0.00    0.00   96.04</div><div class="line">08:42:05 AM   20    2.04    0.00    0.00    0.00    0.00    0.00    0.00    0.00   97.96</div><div class="line">08:42:05 AM   21    2.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.00</div><div class="line">08:42:05 AM   22    3.03    0.00    0.00    0.00    0.00    0.00    0.00    0.00   96.97</div><div class="line">08:42:05 AM   23    2.04    0.00    0.00    0.00    0.00    0.00    0.00    0.00   97.96</div><div class="line">08:42:05 AM   24    4.95    0.00    0.00    0.00    0.00    0.00    0.00    0.00   95.05</div><div class="line">08:42:05 AM   25    2.02    0.00    0.00    0.00    0.00    0.00    0.00    0.00   97.98</div><div class="line">08:42:05 AM   26    3.03    0.00    0.00    0.00    0.00    0.00    0.00    0.00   96.97</div><div class="line">08:42:05 AM   27    2.04    0.00    0.00    0.00    0.00    0.00    0.00    0.00   97.96</div><div class="line">08:42:05 AM   28    1.01    0.00    1.01    0.00    0.00    0.00    0.00    0.00   97.98</div><div class="line">08:42:05 AM   29    1.02    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.98</div><div class="line">08:42:05 AM   30    1.01    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.99</div><div class="line">08:42:05 AM   31    1.02    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.98</div></pre></td></tr></table></figure>
<h4 id="何优化软中断CPU0过高问题"><a href="#何优化软中断CPU0过高问题" class="headerlink" title="何优化软中断CPU0过高问题"></a>何优化软中断CPU0过高问题</h4><h5 id="RSS-Receive-Side-Scaling，需网卡支持多队列"><a href="#RSS-Receive-Side-Scaling，需网卡支持多队列" class="headerlink" title="RSS(Receive Side Scaling，需网卡支持多队列)"></a>RSS(Receive Side Scaling，需网卡支持多队列)</h5><h5 id="查看网卡是否支持队列"><a href="#查看网卡是否支持队列" class="headerlink" title="查看网卡是否支持队列"></a>查看网卡是否支持队列</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">root@geekwolf:~# lscpi -vvv</div><div class="line">06:00.0 Ethernet controller: Broadcom Corporation BCM57840 NetXtreme II 10/20-Gigabit Ethernet (rev 11)</div><div class="line"> Subsystem: Hewlett-Packard Company Device 22fa</div><div class="line"> Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+</div><div class="line"> Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;tabort - &lt;MAbort- &gt;SERR- &lt;perr - INTx-</div><div class="line"> Latency: 0, Cache Line Size: 64 bytes</div><div class="line"> Interrupt: pin A routed to IRQ 32</div><div class="line"> Region 0: Memory at 93800000 (64-bit, prefetchable) [size=8M]</div><div class="line"> Region 2: Memory at 93000000 (64-bit, prefetchable) [size=8M]</div><div class="line"> Region 4: Memory at 95000000 (64-bit, prefetchable) [size=64K]</div><div class="line"> [virtual] Expansion ROM at 95080000 [disabled] [size=512K]</div><div class="line"> Capabilities: [48] Power Management version 3</div><div class="line">   Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0+,D1-,D2-,D3hot+,D3cold+)</div><div class="line">   Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=1 PME-</div><div class="line"> Capabilities: [50] Vital Product Data</div><div class="line">   Product Name: HP FlexFabric 10Gb 2-port 536FLB Adapter</div><div class="line">   Read-only fields:</div><div class="line">     [PN] Part number: 766488-001</div><div class="line">     [EC] Engineering changes: A-5444</div><div class="line">     [MN] Manufacture ID: 31 30 33 43</div><div class="line">     [V0] Vendor specific: 12W PCIeGen3</div><div class="line">     [V1] Vendor specific: 7.10.55</div><div class="line">     [V3] Vendor specific: 7.10.72</div><div class="line">     [V5] Vendor specific: 0A</div><div class="line">     [V6] Vendor specific: 7.10.72</div><div class="line">     [V7] Vendor specific: 536FLB</div><div class="line">     [SN] Serial number: 7C444703LG</div><div class="line">     [V2] Vendor specific: 5447</div><div class="line">     [V4] Vendor specific: 8CDCD419D870</div><div class="line">     [RV] Reserved: checksum good, 186 byte(s) reserved</div><div class="line">   End</div><div class="line"> Capabilities: [a0] MSI-X: Enable+ Count=32 Masked-</div></pre></td></tr></table></figure>
<p>找到Ethernet controller项，如果有MSI-X,Enable+ 并且Count&gt;1，表示该网卡支持多队列</p>
<h5 id="查看网卡支持多少个队列"><a href="#查看网卡支持多少个队列" class="headerlink" title="查看网卡支持多少个队列"></a>查看网卡支持多少个队列</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">root@geekwolf:~# grep eth0 /proc/interrupts |awk &apos;&#123;print $NF&#125;&apos;</div><div class="line">eth0</div><div class="line">eth0-fp-0</div><div class="line">eth0-fp-1</div><div class="line">eth0-fp-2</div><div class="line">eth0-fp-3</div><div class="line">eth0-fp-4</div><div class="line">eth0-fp-5</div><div class="line">eth0-fp-6</div><div class="line">eth0-fp-7</div></pre></td></tr></table></figure>
<h5 id="配置SMP-IRQ-affinity"><a href="#配置SMP-IRQ-affinity" class="headerlink" title="配置SMP IRQ affinity"></a>配置SMP IRQ affinity</h5><p>(即绑定队列到不同CPU,Kernel&gt;2.4)</p>
<p>方法1：开启系统irqbalance服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apt-get -y install irqbalance</div><div class="line">service irqbalance start</div></pre></td></tr></table></figure>
<p>方法2: 手动绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/proc/irq/：该目录下存放的是以IRQ号命名的目录，如/proc/irq/40/，表示中断号为40的相关信息</div><div class="line">/proc/irq/[irq_num]/smp_affinity：该文件存放的是CPU位掩码（十六进制）。修改该文件中的值可以改变CPU和某中断的亲和性</div><div class="line">/proc/irq/[irq_num]/smp_affinity_list：该文件存放的是CPU列表（十进制）。注意，CPU核心个数用表示编号从0开始，如cpu0,cpu1等,</div><div class="line"></div><div class="line">smp_affinity和smp_affinity_list修改其一即可，下面修改smp_affinity：</div><div class="line"></div><div class="line">echo $bitmask &gt; /proc/irq/IRQ#/smp_affinity</div><div class="line">示例(把140号中断绑定到前4个CPU[cpu0-3]上面):</div><div class="line">echo  f &gt;/proc/irq/140/smp_affinity</div></pre></td></tr></table></figure>
<h5 id="CPU位掩码计算"><a href="#CPU位掩码计算" class="headerlink" title="CPU位掩码计算"></a>CPU位掩码计算</h5><p>一个十六进制f转换成二进制为1111，每一位表示一个CPU核，最靠右值是最低位即CPU0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">       Binary       Hex</div><div class="line">CPU 0    0001         1</div><div class="line">CPU 1    0010         2</div><div class="line">CPU 2    0100         4</div><div class="line">CPU 3    1000         8</div><div class="line">其中十六进制2就表示CPU1，十六进制8就表示CPU3</div><div class="line"></div><div class="line">       Binary       Hex</div><div class="line">CPU 0    0001         1</div><div class="line">+ CPU 2    0100         4</div><div class="line">-----------------------</div><div class="line">both     0101         5</div><div class="line">其中得出的十六进制和5表示CPU0 和CPU2</div><div class="line"></div><div class="line">       Binary       Hex</div><div class="line">CPU 0    0001         1</div><div class="line">CPU 1    0010         2</div><div class="line">CPU 2    0100         4</div><div class="line">+ CPU 3    1000         8</div><div class="line">-----------------------</div><div class="line">both     1111         f</div><div class="line">4个CPU参与中断，即可设置为f，8个CPU参与中断可设置为ff，以此类推</div></pre></td></tr></table></figure>
<h5 id="配置RSS"><a href="#配置RSS" class="headerlink" title="配置RSS"></a>配置RSS</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">过滤eth0中断号，绑定到0-7号CPU核上（eth0-fp命名可能有所不同）:</div><div class="line">root@geekwolf:~# grep eth0-fp /proc/interrupts |awk &apos;&#123;print $1, $NF&#125;&apos;</div><div class="line">147: eth0-fp-0</div><div class="line">148: eth0-fp-1</div><div class="line">149: eth0-fp-2</div><div class="line">150: eth0-fp-3</div><div class="line">151: eth0-fp-4</div><div class="line">152: eth0-fp-5</div><div class="line">153: eth0-fp-6</div><div class="line">154: eth0-fp-7</div><div class="line"></div><div class="line">echo 1  &gt;/proc/irq/147/smp_affinity</div><div class="line">echo 2  &gt;/proc/irq/148/smp_affinity</div><div class="line">echo 4  &gt;/proc/irq/149/smp_affinity</div><div class="line">echo 8  &gt;/proc/irq/150/smp_affinity</div><div class="line">echo 10 &gt;/proc/irq/151/smp_affinity</div><div class="line">echo 20 &gt;/proc/irq/152/smp_affinity</div><div class="line">echo 40 &gt;/proc/irq/153/smp_affinity</div><div class="line">echo 80 &gt;/proc/irq/154/smp_affinity</div><div class="line">可以通过top命令查看%si是否均衡分摊到0-7核CPU</div></pre></td></tr></table></figure>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol>
<li>启动irqbalance后，手动绑定将失效</li>
<li>当CPU工作在最高性能模式时，irqbalance会均匀分配中断到其他CPU，节能模式时中断会集中分配到CPU0</li>
<li>以上设置均以网卡支持多队列为前提，建议手动绑定SMP IRQ affinity</li>
<li>网卡多队列需tg3,bnx2,bnx2x,b44等驱动的支持，Broadcom的网卡驱动已经内置在内核中向后兼容大部分的2.6内核及大于2.4.24的2.4内核</li>
<li>笔者实际测试过程中遇到BladeCenter HS23刀片服务器Emulex Corporation OneConnect 10Gb NIC (be3)本身支持多队列，在连接到千兆网环境下无法使用多队列问题，万兆网络下可以使用，只好通过下面RPS/RFS方式实现</li>
</ol>
<h4 id="RPS-RFS"><a href="#RPS-RFS" class="headerlink" title="RPS/RFS"></a>RPS/RFS</h4><p>Receive Packet Steering/Receive Flow Streering,软件方式实现CPU均衡，接收包中断的优化<br>RPS: 网卡驱动对每一个数据库包根据四元组(SIP,SPORT,DIP,DPORT)生成HASH值,通过HASH值将每个连接和CPU 绑定<br>RFS： 由于RPS只是单纯的把数据包均衡到不同的CPU上，此时如果应用程序所在CPU和中断处理的CPU不在同一个核，将会对CPU Cache影响很大，RFS的作用就是将应用程序和软中断处理分配到同一个CPU<br>配置步骤:</p>
<p>根据上述说明一个十六进制f表示四个CPU核，那么均衡到32核即ffffffff</p>
<h5 id="配置RPS"><a href="#配置RPS" class="headerlink" title="配置RPS"></a>配置RPS</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">rps_cpus=&apos;ffffffffff&apos;</div><div class="line">for rxdir in /sys/class/net/eth0/queues/rx-*</div><div class="line">do</div><div class="line">echo $rps_cpus &gt;$rxdir/rps_cpus</div><div class="line"></div><div class="line">done</div></pre></td></tr></table></figure>
<h5 id="配置RFS"><a href="#配置RFS" class="headerlink" title="配置RFS"></a>配置RFS</h5><p>RFS扩展了RPS的性能以增加CPU缓存命中率，减少网络延迟,默认是禁用的<br>/proc/sys/net/core/rps_sock_flow_entries<br>设置此文件至同时活跃连接数的最大预期值。对于中等服务器负载，推荐值为 32768 。所有输入的值四舍五入至最接近的2的幂<br>/sys/class/net/device/queues/rx-queue/rps_flow_cnt<br>将 device 改为想要配置的网络设备名称（例如，eth0），将 rx-queue 改为想要配置的接收队列名称（例如，rx-0）。<br>将此文件的值设为 rps_sock_flow_entries 除以 N，其中 N 是设备中接收队列的数量。例如，如果 rps_flow_entries 设为 32768，并且有 16 个配置接收队列，那么 rps_flow_cnt 就应设为 2048。对于单一队列的设备，rps_flow_cnt 的值和 rps_sock_flow_entries 的值是一样的`</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ls /sys/class/net/eth0/queues/rx-*|grep queues|wc -l</div><div class="line">8</div><div class="line">rps_flow_cnt=32768/8=4096</div><div class="line">echo 32768 &gt;/proc/sys/net/core/rps_sock_flow_entries</div><div class="line">for rxdir in /sys/class/net/eth0/queues/rx-*</div><div class="line">do</div><div class="line">echo $rps_cpus &gt;$rxdir/rps_cpus</div><div class="line">echo $rps_flow_cnt &gt;$rxdir/rps_flow_cnt</div><div class="line">done</div><div class="line"></div><div class="line">echo 32768 &gt;/proc/sys/net/core/rps_sock_flow_entries</div></pre></td></tr></table></figure>
<p>优化脚本可参考: <a href="https://github.com/geekwolf/sa-scripts/blob/master/ops-scripts/performance_tuning/set_rps.sh" target="_blank" rel="external">https://github.com/geekwolf/sa-scripts/blob/master/ops-scripts/performance_tuning/set_rps.sh</a></p>
<h4 id="网卡常规优化方案"><a href="#网卡常规优化方案" class="headerlink" title="网卡常规优化方案"></a>网卡常规优化方案</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2017/02/net_stack.jpg" alt=""><br>关于发包的优化XPS 还未做测试，有时间在做补充！</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><blockquote>
<ul>
<li>TCP/UDP压测工具netperf <a href="https://sanwen8.cn/p/P8bHgn.html" target="_blank" rel="external">https://sanwen8.cn/p/P8bHgn.html</a></li>
<li>多队列网卡及网卡中断绑定阐述 <a href="http://www.ywnds.com/?p=4380" target="_blank" rel="external">http://www.ywnds.com/?p=4380</a></li>
<li>Netperf压测数据分析 <a href="http://www.docin.com/p-1654134152.html" target="_blank" rel="external">http://www.docin.com/p-1654134152.html</a></li>
<li>RHEL7.0 Performance_Tuning_Guide <a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Performance_Tuning_Guide/" target="_blank" rel="external">https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Performance_Tuning_Guide/</a></li>
<li>RPS/RFS/RSS 性能测试 <a href="http://www.cnblogs.com/Bozh/archive/2013/03/21/2973769.html" target="_blank" rel="external">http://www.cnblogs.com/Bozh/archive/2013/03/21/2973769.html</a></li>
</ul>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/12/17/centos-zabbix32-install.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/17/centos-zabbix32-install.html" itemprop="url">Centos6.5部署Zabbix3.2(备忘)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-17T13:48:45+08:00">
                2016-12-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/系统监控/" itemprop="url" rel="index">
                    <span itemprop="name">系统监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/12/17/centos-zabbix32-install.html" class="leancloud_visitors" data-flag-title="Centos6.5部署Zabbix3.2(备忘)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h4 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget --no-check-certificate http://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/epel?codeblock=0 -O epel.repo</div><div class="line">wget --no-check-certificate http://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/epel?codeblock=1 -O epel-testing.repo</div><div class="line">yum install  -y http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm</div><div class="line">rpm -Uvh http://mirror.webtatic.com/yum/el6/latest.rpm</div></pre></td></tr></table></figure>
<h4 id="安装LNMP环境及依赖包"><a href="#安装LNMP环境及依赖包" class="headerlink" title="安装LNMP环境及依赖包"></a>安装LNMP环境及依赖包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install nginx Percona-Server-server-57 Percona-Server-client-57 Percona-Server-devel-57 Percona-Server-tokudb-57  php56w php56w-fpm php56w-mysql gcc-c++ libxml2-devel net-snmp-devel  libcurl-devel fping php56w-bcmath php56w-mbstring php56w-gd php56w-xmlwriter php56w-xmlreader</div></pre></td></tr></table></figure>
<h4 id="数据库初始化，支持TokuDB"><a href="#数据库初始化，支持TokuDB" class="headerlink" title="数据库初始化，支持TokuDB"></a>数据库初始化，支持TokuDB</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">数据库初始化</div><div class="line">mysqld --initialize-insecure --user=mysql --datadir=/data/mysql/data/</div><div class="line">启用TokuDB</div><div class="line">ps_tokudb_admin --enable -uroot -pgeekwolf</div><div class="line"></div><div class="line">若无法加载tokudb引擎，请查看huge pages是否关闭：</div><div class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</div><div class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</div></pre></td></tr></table></figure>
<h4 id="安装Zabbix"><a href="#安装Zabbix" class="headerlink" title="安装Zabbix"></a>安装Zabbix</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/3.2.2/zabbix-3.2.2.tar.gz</div><div class="line">    groupadd zabbix</div><div class="line">    useradd -g zabbix -s /sbin/nologin</div><div class="line">    tar xf zabbix-3.2.2.tar.gz</div><div class="line">    ./configure --enable-server --enable-agent --with-mysql --enable-ipv6 --with-net-snmp --with-libcurl --with-libxml2</div><div class="line">    make -j8</div><div class="line">    make install</div></pre></td></tr></table></figure>
<h4 id="配置zabbix-agent"><a href="#配置zabbix-agent" class="headerlink" title="配置zabbix_agent"></a>配置zabbix_agent</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vim /usr/local/etc/zabbix_agentd.conf</div><div class="line">PidFile=/tmp/zabbix_agentd.pid</div><div class="line">LogFile=/tmp/zabbix_agentd.log</div><div class="line">LogFileSize=0</div><div class="line">Server=192.168.1.1</div><div class="line">ServerActive=192.168.1.1</div><div class="line">Hostname=192.168.1.2</div><div class="line">UnsafeUserParameters=1</div></pre></td></tr></table></figure>
<h4 id="配置zabbix-server"><a href="#配置zabbix-server" class="headerlink" title="配置zabbix_server"></a>配置zabbix_server</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">vim /usr/local/etc/zabbix_server.conf</div><div class="line">DBHost=192.168.1.1</div><div class="line">DBName=zabbix</div><div class="line">DBUser=zabbix</div><div class="line">DBPassword=zabbix</div><div class="line">DebugLevel=3</div><div class="line">StartPollers=80</div><div class="line">CacheSize=32M</div><div class="line">TrendCacheSize=32M</div><div class="line">HistoryCacheSize=32M</div><div class="line">LogFile=/tmp/zabbix_server.log</div><div class="line">AlertScriptsPath=/usr/local/etc/scripts</div><div class="line">FpingLocation=/usr/bin/fping</div><div class="line">StartPingers=20</div><div class="line">HousekeepingFrequency=1</div><div class="line">MaxHousekeeperDelete=10000</div><div class="line">Timeout=10</div></pre></td></tr></table></figure>
<h4 id="部署Zabbix-FrontEnd"><a href="#部署Zabbix-FrontEnd" class="headerlink" title="部署Zabbix FrontEnd"></a>部署Zabbix FrontEnd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">cd  zabbix-3.2.2/</div><div class="line">cp frontends/php/* /usr/share/zabbix/</div><div class="line">chown apache.apache /usr/share/zabbix -R</div><div class="line">mysql&gt;create database zabbix;</div><div class="line">mysql&gt;source database/mysql/schema.sql;</div><div class="line">mysql&gt;source database/mysql/images.sql;</div><div class="line">mysql&gt;source database/mysql/data.sql;</div><div class="line">拷贝启动脚本:</div><div class="line">cp  misc/init.d/fedora/core5/* /etc/rc.d/init.d/</div><div class="line">配置Nginx:</div><div class="line">vim /etc/nginx/conf.d/zabbix.conf</div><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    server_name zbx.simlinux.com;</div><div class="line">    index index.html index.php;</div><div class="line">    root /usr/share/zabbix;</div><div class="line">    location ~ \.php$ &#123;</div><div class="line">        fastcgi_pass   127.0.0.1:9000;</div><div class="line">        fastcgi_index  index.php;</div><div class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</div><div class="line">        include        fastcgi_params;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="启动agent和server服务"><a href="#启动agent和server服务" class="headerlink" title="启动agent和server服务"></a>启动agent和server服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">service zabbix_agentd start</div><div class="line">service zabbix_server start</div><div class="line">service nginx reload</div></pre></td></tr></table></figure>
<p>修改php.ini配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">always_populate_raw_post_data = -1</div><div class="line">max_execution_time = 300</div><div class="line">max_input_time = 300</div><div class="line">data.timezone = PRC </div><div class="line">post_max_size=16M</div><div class="line">service php-fpm reload</div></pre></td></tr></table></figure></p>
<h4 id="修改数据表引擎和创建分区表"><a href="#修改数据表引擎和创建分区表" class="headerlink" title="修改数据表引擎和创建分区表"></a>修改数据表引擎和创建分区表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">alter table history engines=&apos;tokudb&apos;;</div><div class="line">alter table history_log engines=&apos;tokudb&apos;;</div><div class="line">alter table history_str engines=&apos;tokudb&apos;;</div><div class="line">alter table history_text engines=&apos;tokudb&apos;;</div><div class="line">alter table trends engines=&apos;tokudb&apos;;</div></pre></td></tr></table></figure>
<p>分区表可参考<a href="http://blog.simlinux.com/archives/1776.html" target="_blank" rel="external">http://blog.simlinux.com/archives/1776.html</a></p>
<h4 id="安装Zabbix-Web"><a href="#安装Zabbix-Web" class="headerlink" title="安装Zabbix Web"></a>安装Zabbix Web</h4><p>访问<a href="http://192.168.1.1" target="_blank" rel="external">http://192.168.1.1</a> 进行安装,默认账号密码: admin zabbix</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/12/zbx.png" alt=""></p>
<h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><p>A. Zabbix设置中文显示时，图形部分字体显示方框<br> <img src="http://blog.simlinux.com/wp-content/uploads/2016/12/zbx-q1.png" alt=""></p>
<p>解决方法：<br>Zabbix默认使用DejaVuSan.ttf字体，不支持中文<br>拷贝本地C:\Windows\Fonts下的微软雅黑字体上传到Zabbix Web目录fonts下,即msyh.ttf<br>sed -i ‘s/DejaVuSans/msyh/g’ ./include/defines.inc.php</p>
<p>B. Zabbix_server日志提示20434:20161217:105010.997 fping failed: fping6: Address family for hostname not supported<br>解决方法:<br>zabbix_server.conf中指定fping和fping6路径<br>FpingLocation=/usr/sbin/fping<br>Fping6Location=/usr/sbin/fping6</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/12/10/zabbix-mysql-performance.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/10/zabbix-mysql-performance.html" itemprop="url">Zabbix数据库优化总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-10T17:48:46+08:00">
                2016-12-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/系统监控/" itemprop="url" rel="index">
                    <span itemprop="name">系统监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/12/10/zabbix-mysql-performance.html" class="leancloud_visitors" data-flag-title="Zabbix数据库优化总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p> <strong>目的:</strong> 快速清理历史数据，并减少数据存储容量<br> <strong>方法</strong>: 历史表使用分区表(删除分区表速度快),使用Tokudb引擎(适合大量insert少量update和select等日志表)</p>
</blockquote>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><blockquote>
<p><strong>Zabbix版本:</strong> 2.4<br><strong>涉及表项:</strong><br>  存储不同类型item的历史数据，最终1小时或者1天等段时间的绘图数据从其中获取<br>  history、history_log、history_str、history_text、history_uint<br>  存储不同类型item的历史趋势数据，每隔一小时从历史数据中统计一次，并计算统计区间的平均值，最大值，最小值trends、trends_uint</p>
</blockquote>
<h4 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h4><h5 id="关闭zabbix的housekeeper功能"><a href="#关闭zabbix的housekeeper功能" class="headerlink" title="关闭zabbix的housekeeper功能"></a>关闭zabbix的housekeeper功能</h5><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/12/housekeeper.jpg" alt=""></p>
<h5 id="备份原有历史数据表"><a href="#备份原有历史数据表" class="headerlink" title="备份原有历史数据表"></a>备份原有历史数据表</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">rename table history to history_bak;</div><div class="line">rename table history_log to history_log_bak;</div><div class="line">rename table history_str to history_str_bak;</div><div class="line">rename table history_text to history_text_bak;</div><div class="line">rename table history_unit to history_unit_bak;</div><div class="line">rename table trends to trends_bak;</div><div class="line">rename table trends_unit to trends_unit_bak;</div></pre></td></tr></table></figure>
<h5 id="创建新表-使用tokudb引擎"><a href="#创建新表-使用tokudb引擎" class="headerlink" title="创建新表(使用tokudb引擎)"></a>创建新表(使用tokudb引擎)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">`CREATE TABLE `history` (</div><div class="line">  `itemid` bigint(20) unsigned NOT NULL,</div><div class="line">  `clock` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value` double(16,4) NOT NULL DEFAULT &apos;0.0000&apos;,</div><div class="line">  `ns` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  KEY `history_1` (`itemid`,`clock`)</div><div class="line">) ENGINE=Tokudb DEFAULT CHARSET=utf8；</div><div class="line"> CREATE TABLE `history_log` (</div><div class="line">  `id` bigint(20) unsigned NOT NULL,</div><div class="line">  `itemid` bigint(20) unsigned NOT NULL,</div><div class="line">  `clock` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `timestamp` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `source` varchar(64) NOT NULL DEFAULT &apos;&apos;,</div><div class="line">  `severity` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value` text NOT NULL,</div><div class="line">  `logeventid` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `ns` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  UNIQUE KEY `history_log_2` (`itemid`,`id`),</div><div class="line">  KEY `history_log_1` (`itemid`,`clock`)</div><div class="line">) ENGINE=Tokudb DEFAULT CHARSET=utf8；</div><div class="line">CREATE TABLE `history_str` (</div><div class="line">  `itemid` bigint(20) unsigned NOT NULL,</div><div class="line">  `clock` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value` varchar(255) NOT NULL DEFAULT &apos;&apos;,</div><div class="line">  `ns` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  KEY `history_str_1` (`itemid`,`clock`)</div><div class="line">) ENGINE=Tokudb DEFAULT CHARSET=utf8；</div><div class="line">CREATE TABLE `history_text` (</div><div class="line">  `id` bigint(20) unsigned NOT NULL,</div><div class="line">  `itemid` bigint(20) unsigned NOT NULL,</div><div class="line">  `clock` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value` text NOT NULL,</div><div class="line">  `ns` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  UNIQUE KEY `history_text_2` (`itemid`,`id`),</div><div class="line">  KEY `history_text_1` (`itemid`,`clock`)</div><div class="line">) ENGINE=Tokudb DEFAULT CHARSET=utf8；</div><div class="line">CREATE TABLE `history_uint` (</div><div class="line">  `itemid` bigint(20) unsigned NOT NULL,</div><div class="line">  `clock` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value` bigint(20) unsigned NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `ns` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  KEY `history_uint_1` (`itemid`,`clock`)</div><div class="line">) ENGINE=Tokudb DEFAULT CHARSET=utf8；</div><div class="line">CREATE TABLE `trends` (</div><div class="line">  `itemid` bigint(20) unsigned NOT NULL,</div><div class="line">  `clock` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `num` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value_min` double(16,4) NOT NULL DEFAULT &apos;0.0000&apos;,</div><div class="line">  `value_avg` double(16,4) NOT NULL DEFAULT &apos;0.0000&apos;,</div><div class="line">  `value_max` double(16,4) NOT NULL DEFAULT &apos;0.0000&apos;,</div><div class="line">  PRIMARY KEY (`itemid`,`clock`)</div><div class="line">) ENGINE=Tokudb DEFAULT CHARSET=utf8；</div><div class="line">CREATE TABLE `trends_uint` (</div><div class="line">  `itemid` bigint(20) unsigned NOT NULL,</div><div class="line">  `clock` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `num` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value_min` bigint(20) unsigned NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value_avg` bigint(20) unsigned NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  `value_max` bigint(20) unsigned NOT NULL DEFAULT &apos;0&apos;,</div><div class="line">  PRIMARY KEY (`itemid`,`clock`)</div><div class="line">) ENGINE=Tokudb DEFAULT CHARSET=utf8；</div></pre></td></tr></table></figure>
<h5 id="更改索引结构-新版本无需更改"><a href="#更改索引结构-新版本无需更改" class="headerlink" title="更改索引结构(新版本无需更改)"></a>更改索引结构(新版本无需更改)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE history_text DROP PRIMARY KEY,</div><div class="line">ADD INDEX (id),</div><div class="line">DROP INDEX history_text_2,</div><div class="line">ADD INDEX history_text_2 (itemid, id);</div><div class="line">ALTER TABLE history_log DROP PRIMARY KEY,</div><div class="line">ADD INDEX (id),</div><div class="line">DROP INDEX history_log_2,</div><div class="line">ADD INDEX history_log_2 (itemid, id);</div></pre></td></tr></table></figure>
<h5 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h5><blockquote>
<p>partition_create 增加分区存储过程<br>partition_drop 删除分区存储过程<br>partition_maintenance 分区维护(创建删除逻辑)存储过程<br>partition_maintenance_all 分区维护(调用partition_maintenance )<br>partition_verify 检查分区、创建第一个分区的存储过程</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div></pre></td><td class="code"><pre><div class="line">**************************************partition_create**************************************</div><div class="line">DELIMITER $$</div><div class="line">CREATE PROCEDURE `partition_create`(SCHEMANAME varchar(64), TABLENAME varchar(64), PARTITIONNAME varchar(64), CLOCK int)</div><div class="line">BEGIN</div><div class="line">      /*</div><div class="line">         SCHEMANAME = The DB schema in which to make changes</div><div class="line">         TABLENAME = The table with partitions to potentially delete</div><div class="line">         PARTITIONNAME = The name of the partition to create</div><div class="line">      */</div><div class="line">      /*</div><div class="line">         Verify that the partition does not already exist</div><div class="line">      */</div><div class="line"></div><div class="line">      DECLARE RETROWS INT;</div><div class="line">      SELECT COUNT(1) INTO RETROWS</div><div class="line">      FROM information_schema.partitions</div><div class="line">      WHERE table_schema = SCHEMANAME AND table_name = TABLENAME AND partition_description &amp;gt;= CLOCK;</div><div class="line"></div><div class="line">      IF RETROWS = 0 THEN</div><div class="line">              /*</div><div class="line">                 1\. Print a message indicating that a partition was created.</div><div class="line">                 2\. Create the SQL to create the partition.</div><div class="line">                 3\. Execute the SQL from #2.</div><div class="line">              */</div><div class="line">              SELECT CONCAT( &quot;partition_create(&quot;, SCHEMANAME, &quot;,&quot;, TABLENAME, &quot;,&quot;, PARTITIONNAME, &quot;,&quot;, CLOCK, &quot;)&quot; ) AS msg;</div><div class="line">              SET @sql = CONCAT( &apos;ALTER TABLE &apos;, SCHEMANAME, &apos;.&apos;, TABLENAME, &apos; ADD PARTITION (PARTITION &apos;, PARTITIONNAME, &apos; VALUES LESS THAN (&apos;, CLOCK, &apos;));&apos; );</div><div class="line">              PREPARE STMT FROM @sql;</div><div class="line">              EXECUTE STMT;</div><div class="line">              DEALLOCATE PREPARE STMT;</div><div class="line">      END IF;</div><div class="line">END$$</div><div class="line">DELIMITER ;</div><div class="line">**************************************partition_drop**************************************</div><div class="line">DELIMITER $$</div><div class="line">CREATE PROCEDURE `partition_drop`(SCHEMANAME VARCHAR(64), TABLENAME VARCHAR(64), DELETE_BELOW_PARTITION_DATE BIGINT)</div><div class="line">BEGIN</div><div class="line">      /*</div><div class="line">         SCHEMANAME = The DB schema in which to make changes</div><div class="line">         TABLENAME = The table with partitions to potentially delete</div><div class="line">         DELETE_BELOW_PARTITION_DATE = Delete any partitions with names that are dates older than this one (yyyy-mm-dd)</div><div class="line">      */</div><div class="line">      DECLARE done INT DEFAULT FALSE;</div><div class="line">      DECLARE drop_part_name VARCHAR(16);</div><div class="line"></div><div class="line">      /*</div><div class="line">         Get a list of all the partitions that are older than the date</div><div class="line">         in DELETE_BELOW_PARTITION_DATE.  All partitions are prefixed with</div><div class="line">         a &quot;p&quot;, so use SUBSTRING TO get rid of that character.</div><div class="line">      */</div><div class="line">      DECLARE myCursor CURSOR FOR</div><div class="line">              SELECT partition_name</div><div class="line">              FROM information_schema.partitions</div><div class="line">              WHERE table_schema = SCHEMANAME AND table_name = TABLENAME AND CAST(SUBSTRING(partition_name FROM 2) AS UNSIGNED) &amp;lt; DELETE_BELOW_PARTITION_DATE;</div><div class="line">      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;</div><div class="line"></div><div class="line">      /*</div><div class="line">         Create the basics for when we need to drop the partition.  Also, create</div><div class="line">         @drop_partitions to hold a comma-delimited list of all partitions that</div><div class="line">         should be deleted.</div><div class="line">      */</div><div class="line">      SET @alter_header = CONCAT(&quot;ALTER TABLE &quot;, SCHEMANAME, &quot;.&quot;, TABLENAME, &quot; DROP PARTITION &quot;);</div><div class="line">      SET @drop_partitions = &quot;&quot;;</div><div class="line"></div><div class="line">      /*</div><div class="line">         Start looping through all the partitions that are too old.</div><div class="line">      */</div><div class="line">      OPEN myCursor;</div><div class="line">      read_loop: LOOP</div><div class="line">              FETCH myCursor INTO drop_part_name;</div><div class="line">              IF done THEN</div><div class="line">                      LEAVE read_loop;</div><div class="line">              END IF;</div><div class="line">              SET @drop_partitions = IF(@drop_partitions = &quot;&quot;, drop_part_name, CONCAT(@drop_partitions, &quot;,&quot;, drop_part_name));</div><div class="line">      END LOOP;</div><div class="line">      IF @drop_partitions != &quot;&quot; THEN</div><div class="line">              /*</div><div class="line">                 1\. Build the SQL to drop all the necessary partitions.</div><div class="line">                 2\. Run the SQL to drop the partitions.</div><div class="line">                 3\. Print out the table partitions that were deleted.</div><div class="line">              */</div><div class="line">              SET @full_sql = CONCAT(@alter_header, @drop_partitions, &quot;;&quot;);</div><div class="line">              PREPARE STMT FROM @full_sql;</div><div class="line">              EXECUTE STMT;</div><div class="line">              DEALLOCATE PREPARE STMT;</div><div class="line"></div><div class="line">              SELECT CONCAT(SCHEMANAME, &quot;.&quot;, TABLENAME) AS `table`, @drop_partitions AS `partitions_deleted`;</div><div class="line">      ELSE</div><div class="line">              /*</div><div class="line">                 No partitions are being deleted, so print out &quot;N/A&quot; (Not applicable) to indicate</div><div class="line">                 that no changes were made.</div><div class="line">              */</div><div class="line">              SELECT CONCAT(SCHEMANAME, &quot;.&quot;, TABLENAME) AS `table`, &quot;N/A&quot; AS `partitions_deleted`;</div><div class="line">      END IF;</div><div class="line">END$$</div><div class="line">DELIMITER ;</div><div class="line">**************************************partition_verify**************************************</div><div class="line">DELIMITER $$</div><div class="line">CREATE PROCEDURE `partition_verify`(SCHEMANAME VARCHAR(64), TABLENAME VARCHAR(64), HOURLYINTERVAL INT(11))</div><div class="line">BEGIN</div><div class="line">      DECLARE PARTITION_NAME VARCHAR(16);</div><div class="line">      DECLARE RETROWS INT(11);</div><div class="line">      DECLARE FUTURE_TIMESTAMP TIMESTAMP;</div><div class="line"></div><div class="line">      /*</div><div class="line">       * Check if any partitions exist for the given SCHEMANAME.TABLENAME.</div><div class="line">       */</div><div class="line">      SELECT COUNT(1) INTO RETROWS</div><div class="line">      FROM information_schema.partitions</div><div class="line">      WHERE table_schema = SCHEMANAME AND table_name = TABLENAME AND partition_name IS NULL;</div><div class="line"></div><div class="line">      /*</div><div class="line">       * If partitions do not exist, go ahead and partition the table</div><div class="line">       */</div><div class="line">      IF RETROWS = 1 THEN</div><div class="line">              /*</div><div class="line">               * Take the current date at 00:00:00 and add HOURLYINTERVAL to it.  This is the timestamp below which we will store values.</div><div class="line">               * We begin partitioning based on the beginning of a day.  This is because we don&apos;t want to generate a random partition</div><div class="line">               * that won&apos;t necessarily fall in line with the desired partition naming (ie: if the hour interval is 24 hours, we could</div><div class="line">               * end up creating a partition now named &quot;p201403270600&quot; when all other partitions will be like &quot;p201403280000&quot;).</div><div class="line">               */</div><div class="line">              SET FUTURE_TIMESTAMP = TIMESTAMPADD(HOUR, HOURLYINTERVAL, CONCAT(CURDATE(), &quot; &quot;, &apos;00:00:00&apos;));</div><div class="line">              SET PARTITION_NAME = DATE_FORMAT(CURDATE(), &apos;p%Y%m%d%H00&apos;);</div><div class="line"></div><div class="line">              -- Create the partitioning query</div><div class="line">              SET @__PARTITION_SQL = CONCAT(&quot;ALTER TABLE &quot;, SCHEMANAME, &quot;.&quot;, TABLENAME, &quot; PARTITION BY RANGE(`clock`)&quot;);</div><div class="line">              SET @__PARTITION_SQL = CONCAT(@__PARTITION_SQL, &quot;(PARTITION &quot;, PARTITION_NAME, &quot; VALUES LESS THAN (&quot;, UNIX_TIMESTAMP(FUTURE_TIMESTAMP), &quot;));&quot;);</div><div class="line"></div><div class="line">              -- Run the partitioning query</div><div class="line">              PREPARE STMT FROM @__PARTITION_SQL;</div><div class="line">              EXECUTE STMT;</div><div class="line">              DEALLOCATE PREPARE STMT;</div><div class="line">      END IF;</div><div class="line">END$$</div><div class="line">DELIMITER ;</div><div class="line">**************************************partition_maintenance**************************************</div><div class="line">DELIMITER $$</div><div class="line">CREATE PROCEDURE `partition_maintenance`(SCHEMA_NAME VARCHAR(32), TABLE_NAME VARCHAR(32), KEEP_DATA_DAYS INT, HOURLY_INTERVAL INT, CREATE_NEXT_INTERVALS INT)</div><div class="line">BEGIN</div><div class="line">      DECLARE OLDER_THAN_PARTITION_DATE VARCHAR(16);</div><div class="line">      DECLARE PARTITION_NAME VARCHAR(16);</div><div class="line">      DECLARE OLD_PARTITION_NAME VARCHAR(16);</div><div class="line">      DECLARE LESS_THAN_TIMESTAMP INT;</div><div class="line">      DECLARE CUR_TIME INT;</div><div class="line"></div><div class="line">      CALL partition_verify(SCHEMA_NAME, TABLE_NAME, HOURLY_INTERVAL);</div><div class="line">      SET CUR_TIME = UNIX_TIMESTAMP(DATE_FORMAT(NOW(), &apos;%Y-%m-%d 00:00:00&apos;));</div><div class="line"></div><div class="line">      SET @__interval = 1;</div><div class="line">      create_loop: LOOP</div><div class="line">              IF @__interval &amp;gt; CREATE_NEXT_INTERVALS THEN</div><div class="line">                      LEAVE create_loop;</div><div class="line">              END IF;</div><div class="line"></div><div class="line">              SET LESS_THAN_TIMESTAMP = CUR_TIME + (HOURLY_INTERVAL * @__interval * 3600);</div><div class="line">              SET PARTITION_NAME = FROM_UNIXTIME(CUR_TIME + HOURLY_INTERVAL * (@__interval - 1) * 3600, &apos;p%Y%m%d%H00&apos;);</div><div class="line">              IF(PARTITION_NAME != OLD_PARTITION_NAME) THEN</div><div class="line">                      CALL partition_create(SCHEMA_NAME, TABLE_NAME, PARTITION_NAME, LESS_THAN_TIMESTAMP);</div><div class="line">              END IF;</div><div class="line">              SET @__interval=@__interval+1;</div><div class="line">              SET OLD_PARTITION_NAME = PARTITION_NAME;</div><div class="line">      END LOOP;</div><div class="line"></div><div class="line">      SET OLDER_THAN_PARTITION_DATE=DATE_FORMAT(DATE_SUB(NOW(), INTERVAL KEEP_DATA_DAYS DAY), &apos;%Y%m%d0000&apos;);</div><div class="line">      CALL partition_drop(SCHEMA_NAME, TABLE_NAME, OLDER_THAN_PARTITION_DATE);</div><div class="line"></div><div class="line">END$$</div><div class="line">DELIMITER ;</div><div class="line">**************************************partition_maintenance_all**************************************</div><div class="line">DELIMITER $$</div><div class="line">CREATE PROCEDURE `partition_maintenance_all`(SCHEMA_NAME VARCHAR(32))</div><div class="line">BEGIN</div><div class="line">    CALL partition_maintenance(SCHEMA_NAME, &apos;history&apos;, 90, 24, 30);</div><div class="line">    #针对zabbix数据库（调用时传入zabbix数据库的库名）的history表创建分区，数据保留90天，分区时间间隔为24小时，每次创建30个分区</div><div class="line">    CALL partition_maintenance(SCHEMA_NAME, &apos;history_log&apos;, 90, 24, 30);</div><div class="line">    CALL partition_maintenance(SCHEMA_NAME, &apos;history_str&apos;, 90, 24, 30);</div><div class="line">    CALL partition_maintenance(SCHEMA_NAME, &apos;history_text&apos;, 90, 24, 30);</div><div class="line">    CALL partition_maintenance(SCHEMA_NAME, &apos;history_uint&apos;, 90, 24, 30);</div><div class="line">    CALL partition_maintenance(SCHEMA_NAME, &apos;trends&apos;, 730, 24, 15);</div><div class="line">    CALL partition_maintenance(SCHEMA_NAME, &apos;trends_uint&apos;, 730, 24, 30);</div><div class="line">END$$</div><div class="line">DELIMITER ;</div></pre></td></tr></table></figure>
<h5 id="设置分区表维护Event-Scheduler"><a href="#设置分区表维护Event-Scheduler" class="headerlink" title="设置分区表维护Event Scheduler"></a>设置分区表维护Event Scheduler</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">开启数据库Event Scheduler功能</div><div class="line">set GLOBAL event_scheduler=ON;</div><div class="line">创建事件zbx_partition_maintenance 每月1号1点执行partition_maintenance_all:</div><div class="line">DELIMITER $$</div><div class="line">CREATE EVENT `zbx_partition_maintenance`</div><div class="line">ON SCHEDULE every 1 month starts date_add(date_add(date_sub(curdate(),interval day(curdate())-1 day),interval 1 month),interval 1 HOUR)</div><div class="line">ON COMPLETION PRESERVE DO</div><div class="line">BEGIN</div><div class="line">    CALL partition_maintenance_all(&apos;zabbix&apos;) ; </div><div class="line">END$$</div><div class="line">DELIMITER ;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/12/10/zabbix-cpucores-lld.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/10/zabbix-cpucores-lld.html" itemprop="url">zabbix LLD之多核CPU监控(备忘)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-10T16:57:48+08:00">
                2016-12-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/系统监控/" itemprop="url" rel="index">
                    <span itemprop="name">系统监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/12/10/zabbix-cpucores-lld.html" class="leancloud_visitors" data-flag-title="zabbix LLD之多核CPU监控(备忘)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<ul>
<li>使用Zabbix自带的system.cpu.discovery实现CPU多核监控</li>
<li>Zabbix Agent 2.4+以上版本才开始支持</li>
</ul>
</blockquote>
<h4 id="创建发现规则"><a href="#创建发现规则" class="headerlink" title="创建发现规则"></a>创建发现规则</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/12/cpu_multi.jpg" alt=""></p>
<h4 id="创建监控项"><a href="#创建监控项" class="headerlink" title="创建监控项"></a>创建监控项</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/12/cpu_item.png" alt=""></p>
<h4 id="根据监控项创建图形"><a href="#根据监控项创建图形" class="headerlink" title="根据监控项创建图形"></a>根据监控项创建图形</h4><h4 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/12/cpu_trigger.png" alt=""></p>
<h4 id="展示效果"><a href="#展示效果" class="headerlink" title="展示效果"></a>展示效果</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/12/cpu-core-pic.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/10/26/zabbix-trap-sender.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/26/zabbix-trap-sender.html" itemprop="url">通过zabbix_sender实现批量传递key值(备忘)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-26T17:58:52+08:00">
                2016-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/系统监控/" itemprop="url" rel="index">
                    <span itemprop="name">系统监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/10/26/zabbix-trap-sender.html" class="leancloud_visitors" data-flag-title="通过zabbix_sender实现批量传递key值(备忘)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>选择使用zabbix_sender的由来基于业务中需要从MySQL数据库中提取游戏在线人数(5个服务)，如果通过zabbix_get方式获取需要执行5次脚本获取，而通过zabbix_sender执行一次脚本可将5个服务的数据批量发送到zabbix trapper更为方便，减少了不必要的脚本执行</p>
</blockquote>
<p><strong>配置步骤如下:</strong></p>
<p><strong>1.配置zabbix_agentd.conf 自定义UserParameter</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">UserParameter=send.online.count.data[*],/home/opt/scripts/online_count.sh $1</div><div class="line">/etc/init.d/zabbix_agent stop</div><div class="line">/etc/init.d/zabbix_agent start</div></pre></td></tr></table></figure></p>
<p>注释: 此步骤的目的是在zabbix server上创建key为send.online.count.data的item用于设置脚本的执行间隔，也可以在zabbix agent服务上设置crontab实现</p>
<p><strong>2.数据获取脚本</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">host_ip=$1</div><div class="line">zabbix_server_ip=&quot;10.1.1.1&quot;</div><div class="line">mysql  -C -N  -h localhost -u geekwolf -pgeekwolf &quot;--execute=select total,dota,war3vs,war3rpg,first_login from online_table;&quot;&gt;/tmp/.data</div><div class="line">Total=`cat /tmp/.data |awk &apos;&#123;print $1&#125;&apos;`</div><div class="line">Dota=`cat /tmp/.data |awk &apos;&#123;print $2&#125;&apos;`</div><div class="line">War3vs=`cat /tmp/.data |awk &apos;&#123;print $3&#125;&apos;`</div><div class="line">War3rpg=`cat /tmp/.data |awk &apos;&#123;print $4&#125;&apos;`</div><div class="line">First_Login=`cat /tmp/.data |awk &apos;&#123;print $5&#125;&apos;`</div><div class="line"></div><div class="line">echo &quot;$host_ip online_count[Total] $Total&quot; &gt;/tmp/count.log</div><div class="line">echo &quot;$host_ip online_count[Dota] $Dota&quot; &gt;&gt;/tmp/count.log</div><div class="line">echo &quot;$host_ip online_count[War3vs] $War3vs&quot; &gt;&gt;/tmp/count.log</div><div class="line">echo &quot;$host_ip online_count[War3rpg] $War3rpg&quot; &gt;&gt;/tmp/count.log</div><div class="line">echo &quot;$host_ip online_count[First_login] $First_Login&quot; &gt;&gt;/tmp/count.log</div><div class="line">zabbix_sender -z $zabbix_server_ip -i /tmp/count.log &gt;/dev/null</div></pre></td></tr></table></figure></p>
<p><strong>3.创建模板和项目</strong><br>A. 创建模板Online_Count_Template<br>B. 创建项目send.count.data<br><img src="http://blog.simlinux.com/wp-content/uploads/2016/10/t1.png" alt=""></p>
<p>C. 创建Total监控项,其他略<br><img src="http://blog.simlinux.com/wp-content/uploads/2016/10/t2.png" alt=""></p>
<p><strong>4. 创建图形</strong><br><img src="http://blog.simlinux.com/wp-content/uploads/2016/10/t3.png" alt=""></p>
<p><strong>5. 将模板关联到主机即可(可通过最新数据查看是否有数据上报 )</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/08/02/zabbix-traffic-sum.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/02/zabbix-traffic-sum.html" itemprop="url">利用Zabbix做流量聚合汇总</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-02T16:20:46+08:00">
                2016-08-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/系统监控/" itemprop="url" rel="index">
                    <span itemprop="name">系统监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/08/02/zabbix-traffic-sum.html" class="leancloud_visitors" data-flag-title="利用Zabbix做流量聚合汇总">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<ul>
<li>创建主机群组 : 数据大盘</li>
<li>创建主机 : Geekwolf</li>
<li>创建监控项：网卡流入流出，grpsum实现聚合</li>
<li>创建图形：关联监控项</li>
</ul>
</blockquote>
<h4 id="创建主机群组"><a href="#创建主机群组" class="headerlink" title="创建主机群组"></a>创建主机群组</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/08/dashboard.png" alt="此处输入图片的描述"></p>
<h4 id="创建主机Geekwolf"><a href="#创建主机Geekwolf" class="headerlink" title="创建主机Geekwolf"></a>创建主机Geekwolf</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/08/host1.png" alt="此处输入图片的描述"></p>
<h4 id="创建监控项：网卡流入流出，grpsum实现聚合"><a href="#创建监控项：网卡流入流出，grpsum实现聚合" class="headerlink" title="创建监控项：网卡流入流出，grpsum实现聚合"></a>创建监控项：网卡流入流出，grpsum实现聚合</h4><p>点击创建主机界面上方的项目</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/08/host2.png" alt="此处输入图片的描述"><br> <img src="http://blog.simlinux.com/wp-content/uploads/2016/08/host3.png" alt="此处输入图片的描述"></p>
<h4 id="创建图形：关联监控项"><a href="#创建图形：关联监控项" class="headerlink" title="创建图形：关联监控项"></a>创建图形：关联监控项</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/08/host4.png" alt="此处输入图片的描述"></p>
<h4 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/08/traffic.png" alt="此处输入图片的描述"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/04/28/grafana-influxdb-collectd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/28/grafana-influxdb-collectd.html" itemprop="url">Grafana+InfluxDB+Collectd构建监控系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-28T22:39:37+08:00">
                2016-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/系统监控/" itemprop="url" rel="index">
                    <span itemprop="name">系统监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/04/28/grafana-influxdb-collectd.html" class="leancloud_visitors" data-flag-title="Grafana+InfluxDB+Collectd构建监控系统">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h4 id="架构原理"><a href="#架构原理" class="headerlink" title="架构原理"></a>架构原理</h4><blockquote>
<p>Collectd(数据采集,配置Server连接InfluxDB的25826端口) -&gt; InfluxDB(数据存储,启用collectd插件监听25826端口) —&gt; Grafana(数据展示)</p>
<ul>
<li>Collectd ： C 语言开发的一个守护(daemon)进程，周期性收集统计数据和存储，拥有丰富的插件包括监控Ceph,DRBD,OpenLDAP,ZK等，类似statD(graphite也可以用来采集数据，不过展示功能没有Grafana丰富)，数据可以存储在Kafka,InfluxDB，OpenTSDB等上*   InfluxDB:   GO开发的开源分布式时序数据库，适合存储指标，时间，分析等数据</li>
<li>Grafana： 是一个开源的，具有丰富指标仪表盘的数据展示和图表编辑工具，支持Graphite,Elasticsearch,OpenTSDB,Prometheus和influxDB,Zabbix等</li>
</ul>
</blockquote>
<h4 id="Collectd"><a href="#Collectd" class="headerlink" title="Collectd"></a>Collectd</h4><ol>
<li><p>安装collectd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">yum -y  install perl-ExtUtils-Embed perl-ExtUtils-MakeMaker  liboping* </div><div class="line">wget https://collectd.org/files/collectd-5.5.0.tar.gz</div><div class="line">tar xf collectd-5.5.0.tar.gz</div><div class="line">cd collectd-5.5.0</div><div class="line">./configure --enable-cpu  --enable-df --enable-disk --enable-interface --enable-load --enable-memory --enable-ping --enable-swap --enable-users --enable-uptime</div><div class="line">make &amp;amp;&amp;amp; make install</div><div class="line">cp contrib/redhat/init.d-collectd  /etc/rc.d/init.d/collectd</div><div class="line">chmod +x /etc/rc.d/init.d/collectd</div><div class="line">ln -s /opt/collectd/sbin/collectdmon  /usr/sbin/</div><div class="line">ln -s /opt/collectd/sbin/collectd  /usr/sbin/</div></pre></td></tr></table></figure>
</li>
<li><p>配置collectd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">vim /etc/collectd.conf</div><div class="line">BaseDir &quot;/opt/collectd&quot;</div><div class="line">PIDFile &quot;/run/collectd.pid&quot;</div><div class="line">Hostname &quot;host.example.com&quot;</div><div class="line">Interval 60</div><div class="line">&lt;loadplugin df&gt;</div><div class="line">Interval 120</div><div class="line">&lt;/loadplugin&gt;</div><div class="line">LoadPlugin disk</div><div class="line">LoadPlugin interface</div><div class="line">LoadPlugin load</div><div class="line">LoadPlugin memory</div><div class="line">LoadPlugin network</div><div class="line">LoadPlugin processes</div><div class="line">LoadPlugin users</div><div class="line">&lt;plugin interface&gt;</div><div class="line">Interface &quot;eth1&quot;</div><div class="line">IgnoreSelected false</div><div class="line">&lt;/plugin&gt;</div><div class="line">&lt;plugin network&gt;</div><div class="line">Server &quot;10.44.38.244&quot; &quot;25826&quot;</div><div class="line">&lt;/plugin&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>说明<br>默认collectd进程会每10s中调用注册在配置文件中的插件，默认全局参数interval＝10s(10s上报一次数据到influxdb等)，针对不同的插件可以配置不同的搜集数据的时间间隔interval</p>
</li>
</ol>
<h4 id="InfluxDB"><a href="#InfluxDB" class="headerlink" title="InfluxDB"></a>InfluxDB</h4><ol>
<li><p>安装并启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cat &lt; &lt;EOF | sudo tee /etc/yum.repos.d/influxdb.repo</div><div class="line">[influxdb]</div><div class="line">name = InfluxDB Repository - RHEL \$releasever</div><div class="line">baseurl = https://repos.influxdata.com/rhel/\$releasever/\$basearch/stable</div><div class="line">enabled = 1</div><div class="line">gpgcheck = 1</div><div class="line">gpgkey = https://repos.influxdata.com/influxdb.key</div><div class="line">EOF</div><div class="line">yum -y install influxdb</div><div class="line">service influxdb start</div><div class="line">启动后TCP端口:8083 为InfluxDB 管理控制台</div><div class="line">  TCP端口:8086 为客户端和InfluxDB通信时的HTTP API</div><div class="line">启动后InfluxDB用户认证默认是关闭的，先创建用户:geekwolf geekwolf</div><div class="line">命令行输入influx</div></pre></td></tr></table></figure>
</li>
<li><p>基本使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@geekwolf ~]# influx</div><div class="line">Visit https://enterprise.influxdata.com to register for updates, InfluxDB server management, and monitoring.</div><div class="line">Connected to http://localhost:8086 version 0.12.2</div><div class="line">InfluxDB shell 0.12.2</div><div class="line">&gt; create database collectdb</div><div class="line">&gt; create database collectdb</div><div class="line">&gt; show databases</div><div class="line">name: databases</div><div class="line">\------</div><div class="line">name</div><div class="line">_internal</div><div class="line">collectdb</div><div class="line">&gt; create user geekwolf with password &apos;geekwolf&apos;</div><div class="line">&gt; show users</div><div class="line">user            admin</div><div class="line">geekwolf        false</div><div class="line">&gt; grant all on collectdb from to geekwolf</div><div class="line">&gt; help show</div><div class="line">Usage:</div><div class="line">    connect &lt;host:port&gt;   connects to another node specified by host:port</div><div class="line">    auth                  prompts for username and password</div><div class="line">    pretty                toggles pretty print for the json format</div><div class="line">    use &lt;db_name&gt;         sets current database</div><div class="line">    format &lt;format&gt;       specifies the format of the server responses: json, csv, or column</div><div class="line">    precision &lt;/format&gt;&lt;format&gt;    specifies the format of the timestamp: rfc3339, h, m, s, ms, u or ns</div><div class="line">    consistency &lt;level&gt;   sets write consistency level: any, one, quorum, or all</div><div class="line">    history               displays command history</div><div class="line">    settings              outputs the current settings for the shell</div><div class="line">    exit/quit/ctrl+d      quits the influx shell</div><div class="line">    show databases        show database names</div><div class="line">    show series           show series information</div><div class="line">    show measurements     show measurement information</div><div class="line">    show tag keys         show tag key information</div><div class="line">    show field keys       show field key information</div><div class="line">    A full list of influxql commands can be found at:</div><div class="line">    https://docs.influxdata.com/influxdb/v0.10/query_language/spec</div></pre></td></tr></table></figure>
</li>
<li><p>启用认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">修改配置文件启用认证</div><div class="line">sed -i ’s#auth-enabled = false#auth-enabled = true#g’ /etc/influxdb/influxdb.conf</div><div class="line">service influxdb restart</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="配置InfluxDB支持Collectd"><a href="#配置InfluxDB支持Collectd" class="headerlink" title="配置InfluxDB支持Collectd"></a>配置InfluxDB支持Collectd</h4><ol>
<li><p>修改配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">vim /etc/influxdb/influxdb.conf</div><div class="line">[collectd]</div><div class="line">enabled = true</div><div class="line">bind-address = &quot;10.44.38.244:25826&quot;</div><div class="line">database = &quot;collectdb&quot;</div><div class="line">typesdb = &quot;/opt/collectd/share/collectd/types.db&quot;</div><div class="line">batch-size = 5000</div><div class="line">batch-pending = 10</div><div class="line">batch-timeout = &quot;10s&quot;</div><div class="line">read-buffer = 0</div><div class="line">service influxdb restart</div></pre></td></tr></table></figure>
</li>
<li><p>查看metrics信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">[root@geekwolf ~]# influx</div><div class="line">Visit https://enterprise.influxdata.com to register for updates, InfluxDB server management, and monitoring.</div><div class="line">Connected to http://localhost:8086 version 0.12.2</div><div class="line">InfluxDB shell 0.12.2</div><div class="line">&gt; use collectdb</div><div class="line">Using database collectdb</div><div class="line">&gt; show field keys</div><div class="line">name: cpu_value</div><div class="line">---------------</div><div class="line">fieldKey</div><div class="line">value</div><div class="line"></div><div class="line">name: df_free</div><div class="line">-------------</div><div class="line">fieldKey</div><div class="line">value</div><div class="line"></div><div class="line">name: df_used</div><div class="line">-------------</div><div class="line">fieldKey</div><div class="line">value</div><div class="line"></div><div class="line">name: disk_read</div><div class="line">---------------</div><div class="line">fieldKey</div><div class="line">value</div><div class="line">&gt; select * from cpu_value limit 15;</div><div class="line">name: cpu_value</div><div class="line">---------------</div><div class="line">time                    host                    instance        type    type_instance   value</div><div class="line">1461657293000000000     host.example.com        1               cpu     idle            1.59845e+06</div><div class="line">1461657293000000000     host.example.com        1               cpu     system          2316</div><div class="line">1461657293000000000     host.example.com        1               cpu     nice            508</div><div class="line">1461657293000000000     host.example.com        0               cpu     steal           0</div><div class="line">1461657293000000000     host.example.com        1               cpu     user            11619</div><div class="line">1461657293000000000     host.example.com        1               cpu     interrupt       0</div><div class="line">1461657293000000000     host.example.com        1               cpu     steal           0</div><div class="line">1461657293000000000     host.example.com        1               cpu     wait            172</div><div class="line">1461657293000000000     host.example.com        1               cpu     softirq         0</div><div class="line">1461657303000000000     host.example.com        1               cpu     wait            172</div><div class="line">1461657303000000000     host.example.com        1               cpu     softirq         0</div><div class="line">1461657303000000000     host.example.com        1               cpu     nice            508</div><div class="line">1461657303000000000     host.example.com        0               cpu     idle            1.587007e+06</div><div class="line">1461657303000000000     host.example.com        0               cpu     softirq         127</div><div class="line">1461657303000000000     host.example.com        0               cpu     interrupt       54</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="安装配置Grafana"><a href="#安装配置Grafana" class="headerlink" title="安装配置Grafana"></a>安装配置Grafana</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">yum install https://grafanarel.s3.amazonaws.com/builds/grafana-3.0.0-beta51460725904.x86_64.rpm</div><div class="line">目录结构</div><div class="line">/usr/sbin/grafana-server</div><div class="line">/etc/init.d/grafana-server          上述命令的拷贝，启动脚本</div><div class="line">/etc/sysconfig/grafana-server       环境变量</div><div class="line">/etc/grafana/grafana.ini            配置文件</div><div class="line">/var/log/grafana/grafana.log        日志文件</div><div class="line">/var/lib/grafana/grafana.db     sqlite3数据库</div><div class="line"></div><div class="line">启动服务: service grafana-server start</div><div class="line">         chkconfig grafana-server on</div></pre></td></tr></table></figure>
<blockquote>
<p>访问地址:<a href="http://10.44.38.244:3000" target="_blank" rel="external">http://10.44.38.244:3000</a> 默认账号为admin admin</p>
</blockquote>
<p>关闭Grafana注册功能:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i ’s/#allow_sign_up = true/allow_sign_up = false/g’  /etc/grafana/grafana.ini,重启服务</div></pre></td></tr></table></figure></p>
<ul>
<li>添加InfluxDB数据源</li>
</ul>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/04/datasource.png" alt="此处输入图片的描述"></p>
<ul>
<li>添加ping图的例子</li>
</ul>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/04/ping.png" alt="此处输入图片的描述"></p>
<ul>
<li>图表展示</li>
</ul>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/04/view.png" alt="此处输入图片的描述"></p>
<p>详细demo可参考:<a href="http://play.grafana.org/" target="_blank" rel="external">http://play.grafana.org/</a></p>
<h4 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h4><p><strong>问题 :</strong>在使用influxdb0.12.x版本和Grafana2.6时出现multiple query syntax的bug,原因是influxdb的apiwent</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/04/multiquery.png" alt="此处输入图片的描述"></p>
<p><strong>解决方法:</strong> 升级Grafana2.6到Grafana3.0-beta1以上版本<br> <a href="https://github.com/grafana/grafana/commit/ed62822d442569e7ba287ff63d83a069a596c458" target="_blank" rel="external">https://github.com/grafana/grafana/commit/ed62822d442569e7ba287ff63d83a069a596c458</a></p>
<h4 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h4><blockquote>
<p><a href="http://docs.grafana.org" target="_blank" rel="external">http://docs.grafana.org</a><br><a href="https://collectd.org/wiki/index.php/Table_of_Plugins" target="_blank" rel="external">https://collectd.org/wiki/index.php/Table_of_Plugins</a><br><a href="https://docs.influxdata.com/influxdb/v0.12/introduction/getting_started/" target="_blank" rel="external">https://docs.influxdata.com/influxdb/v0.12/introduction/getting_started/</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/04/21/android-pack-deploy.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/21/android-pack-deploy.html" itemprop="url">Android多渠道打包这样做才酸爽！？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-21T16:51:16+08:00">
                2016-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CI-CD/" itemprop="url" rel="index">
                    <span itemprop="name">CI/CD</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/04/21/android-pack-deploy.html" class="leancloud_visitors" data-flag-title="Android多渠道打包这样做才酸爽！？">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>　　多渠道主要目的是为了统计各个应用市场用户数据分析(比如活跃数，崩溃率等)，收集用户信息，这时需要唯一标识来区分这些渠道，本文主要针对多渠道(几百个渠道甚至更多的情况)如何快速打包?</p>
<h4 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h4><blockquote>
<ul>
<li>Jenkins集成Gradle实现打包自动化</li>
<li>通过Jenkins参数化构建实现自定义环境和渠道打包，签名</li>
<li>测试包自动上传fir并通过钉钉发送通知</li>
<li>正式包按版本归档到OSS，发布时拷贝包到发布目录</li>
<li>自动刷新CDN</li>
</ul>
</blockquote>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><blockquote>
<ul>
<li>系统 : Centos6.5 x64</li>
<li>jdk-7u79-linux-x64</li>
<li>android-sdk_r24.4.1-linux</li>
<li>gradle-2.2.1</li>
<li>Python-2.7.10(操作DingTalk和OSS API)</li>
<li>Jenkins2.0/Tomcat-7.0.65</li>
</ul>
</blockquote>
<h4 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h4><p>1.安装JDK</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget &apos;http://download.oracle.com/otn-pub/java/jdk/7u79-b15/jdk-7u79-linux-x64.tar.gz?AuthParam=1460974294_526e0f8471004294cb163c9c730ba4f9&apos; -O jdk1.7.0_79.tar.gz</div><div class="line">tar xf jdk-7u79-linux-x64.tar.gz -C /usr/local/jdk1.7.0_79</div></pre></td></tr></table></figure>
<p>2.安装Python2.7.10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget https://www.python.org/ftp/python/2.7.10/Python-2.7.10.tgz</div><div class="line">tar xf Python-2.7.10.tgz</div><div class="line">cd Python-2.7.10</div><div class="line">./configure </div><div class="line">make -j4</div><div class="line">make install</div><div class="line">sed -i &apos;s#python/python2.6#g&apos; /usr/bin/yum</div></pre></td></tr></table></figure>
<p>3.安装Android的SDK</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget http://dl.google.com/android/android-sdk_r24.4.1-linux.tgz</div><div class="line">tar xf android-sdk_r24.4.1-linux.tgz -C /usr/local/android-sdk-linux</div></pre></td></tr></table></figure>
<p>4.安装tomcat和jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y install tomcat</div><div class="line">wget http://mirrors.jenkins-ci.org/war-rc/2.0/jenkins.war -O /usr/share/tomcat/webapps/jenkins.war</div></pre></td></tr></table></figure>
<p>5.配置环境变量，启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">vim /etc/profile</div><div class="line">export ANDROID_HOME=/usr/local/android-sdk-linux</div><div class="line">export JAVA_HOME=/usr/local/jdk1.7.0_80</div><div class="line">export PATH=$PATH:$JAVA_HOME/bin:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools</div><div class="line">source /etc/profile</div><div class="line">service tomcat start</div><div class="line">Jenkins访问地址:http://192.168.2.2:8080/jenkins/</div></pre></td></tr></table></figure>
<p>6.安装Android SDK依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">由于Android SDK工具基于32位在64位系统上需要安装32位必须安装的i386依赖库</div><div class="line">yum install -y glibc.i686 glibc-devel.i686 libstdc++.i686 zlib-devel.i686 ncurses-devel.i686 libX11-devel.i686 libXrender.i686 libXrandr.i686</div></pre></td></tr></table></figure>
<p>####安装更新对应版本的SDK</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">由于国内直接解析访问dl.google.com,dl-ssl.google.com域名较慢，可以通过更改hosts方式解决:</div><div class="line">dig dl.google.com dl-ssl.google.com</div><div class="line">将获得IP写入/etc/hosts,例如:</div><div class="line">203.208.43.110 dl.google.com</div><div class="line">74.125.23.91 dl-ssl.google.com</div><div class="line">查看SDK相关列表</div><div class="line">android  list sdk --all</div><div class="line">Packages available for installation or update: 150</div><div class="line">alias: archives/1689.html</div><div class="line">alias: archives/1689.html</div><div class="line">   1- Android SDK Tools, revision 25.1.1</div><div class="line">   2- Android SDK Tools, revision 25.1.3 rc1</div><div class="line">   3- Android SDK Platform-tools, revision 23.1</div><div class="line">   4- Android SDK Platform-tools, revision 24 rc2</div><div class="line">   5- Android SDK Build-tools, revision 24 rc3</div><div class="line">   6- Android SDK Build-tools, revision 23.0.3</div><div class="line">   7- Android SDK Build-tools, revision 23.0.2</div><div class="line">   8- Android SDK Build-tools, revision 23.0.1</div><div class="line">   9- Android SDK Build-tools, revision 23 (Obsolete)</div><div class="line">  10- Android SDK Build-tools, revision 22.0.1</div><div class="line">  11- Android SDK Build-tools, revision 22 (Obsolete)</div><div class="line">  12- Android SDK Build-tools, revision 21.1.2</div><div class="line">  13- Android SDK Build-tools, revision 21.1.1 (Obsolete)</div><div class="line">  14- Android SDK Build-tools, revision 21.1 (Obsolete)</div><div class="line">  15- Android SDK Build-tools, revision 21.0.2 (Obsolete)</div><div class="line">  16- Android SDK Build-tools, revision 21.0.1 (Obsolete)</div><div class="line">  17- Android SDK Build-tools, revision 21 (Obsolete)</div><div class="line">  18- Android SDK Build-tools, revision 20</div><div class="line">  19- Android SDK Build-tools, revision 19.1</div><div class="line">  20- Android SDK Build-tools, revision 19.0.3 (Obsolete)</div><div class="line">  21- Android SDK Build-tools, revision 19.0.2 (Obsolete)</div><div class="line">  22- Android SDK Build-tools, revision 19.0.1 (Obsolete)</div><div class="line">  23- Android SDK Build-tools, revision 19 (Obsolete)</div><div class="line">  24- Android SDK Build-tools, revision 18.1.1 (Obsolete)</div><div class="line">  ...</div><div class="line">选择要安装项目的序号</div><div class="line">android  update sdk -u -a -t 5,6,7,31,34,136,137</div></pre></td></tr></table></figure>
<h4 id="手动编译测试Android项目"><a href="#手动编译测试Android项目" class="headerlink" title="手动编译测试Android项目"></a>手动编译测试Android项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">git clone git@git.maka.mobi:android/Android_demo.git</div><div class="line">cd Android_demo</div><div class="line">查看当前项目包含的tasks(此时若无gradle会自动下载安装)</div><div class="line">./gradlew  tasks</div><div class="line">清空build目录</div><div class="line">./gradlew clean</div><div class="line">编译打包所有环境包</div><div class="line">./gradlew assemble</div><div class="line">编译打包Debug包</div><div class="line">./gradlew assembleDebug</div><div class="line">编译打包Release包</div><div class="line">./gradlew assembleRelease</div></pre></td></tr></table></figure>
<h4 id="多渠道打包项目改造"><a href="#多渠道打包项目改造" class="headerlink" title="多渠道打包项目改造"></a>多渠道打包项目改造</h4><ol>
<li>包的签名在build.gradle中配置，打包后自动签名</li>
<li>由于META-INF目录下是存放签名信息的，用来保证apk包的完整性和安全，在生成apk时对文件做校验计算并把结果存放在META-INF目录中，安装apk包时应用管理器会按照同样的算法对包里的文件做校验，如果和META-INF中的内容不一致，则无法安装，通过修改apk包在重新打包基本不可能，以此来保证apk包的安全，因此在打完第一个包时，可以在META-INF目录中添加一个channel_wandoujia空文件,代码匹配这个文件获取渠道名wandoujia，来快速实现多渠道打包的目的</li>
<li>代码库根目录channel文件存放渠道名</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">apk包解压后目录结构:</div><div class="line">├── AndroidManifest.xml</div><div class="line">├── assets</div><div class="line">├── classes.dex</div><div class="line">├── lib</div><div class="line">├── META-INF</div><div class="line">│   ├── CERT.RSA</div><div class="line">│   ├── CERT.SF</div><div class="line">│   ├── channel_huawei</div><div class="line">│   └── MANIFEST.MF</div><div class="line">├── org</div><div class="line">├── res</div><div class="line">└── resources.arsc</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line">Gradle(apk通过gradle签名)例子app/build.gradle:</div><div class="line">apply plugin: &apos;com.android.application&apos;</div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 22</div><div class="line">    buildToolsVersion &apos;23.0.2&apos;</div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId &quot;com.maka.app&quot;</div><div class="line">        minSdkVersion 16</div><div class="line">        targetSdkVersion 22</div><div class="line">        versionCode 16</div><div class="line">        versionName &apos;2.0.0&apos;</div><div class="line"></div><div class="line">        //dex突破65535的限制</div><div class="line">        multiDexEnabled true</div><div class="line">    &#125;</div><div class="line">    dexOptions &#123;</div><div class="line">        jumboMode = true</div><div class="line">        incremental true</div><div class="line">        javaMaxHeapSize &quot;4g&quot;</div><div class="line">        preDexLibraries = false</div><div class="line">        incremental true</div><div class="line">    &#125;</div><div class="line">    signingConfigs &#123;</div><div class="line">        debug &#123;</div><div class="line">            storeFile file(&quot;../key.jks&quot;)</div><div class="line">            storePassword &quot;helloworld&quot;</div><div class="line">            keyAlias &quot;helloworld&quot;</div><div class="line">            keyPassword &quot;helloworld&quot;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    packagingOptions &#123;</div><div class="line">        exclude &apos;META-INF/LICENCE.txt&apos;</div><div class="line">        exclude &apos;META-INF/LICENSE.txt&apos;</div><div class="line">        exclude &apos;META-INF/NOTICE.txt&apos;</div><div class="line">    &#125;</div><div class="line">    lintOptions &#123;</div><div class="line">        checkReleaseBuilds false</div><div class="line">        // Or, if you prefer, you can continue to check for errors in release builds,</div><div class="line">        // but continue the build even when errors are found:</div><div class="line">        abortOnError false</div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        debug &#123;</div><div class="line">            // 显示Log</div><div class="line">            buildConfigField &quot;boolean&quot;, &quot;LOG_DEBUG&quot;, &quot;true&quot;</div><div class="line">            versionNameSuffix &quot;-debug&quot;</div><div class="line">            minifyEnabled false</div><div class="line">            zipAlignEnabled true</div><div class="line">            shrinkResources false</div><div class="line">            signingConfig signingConfigs.debug</div><div class="line">            manifestPlaceholders = [</div><div class="line">                    UMENG_APP_KEY   : &quot;556ac653162s58e06c0000218&quot;,</div><div class="line">                    UMENG_APP_SECRET: &quot;2a231041d6aa10ec2b2s933003135a7&quot;</div><div class="line">            ]</div><div class="line">            //Server config</div><div class="line">            buildConfigField &quot;boolean&quot;, &quot;SELECT_SERVER&quot;, &quot;true&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_IP&quot;, &quot;\&quot;http://test.api.simlinux.com/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_PROJECT_URL&quot;, &quot;\&quot;http://test.viewer.simlinux.com/k/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_PICTURE_URL&quot;, &quot;\&quot;http://test.img1.simlinux.com/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_RES_URL&quot;, &quot;\&quot;http://test.res.simlinux.com/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_IP&quot;, &quot;\&quot;http://api.simlinux.com/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_PROJECT_URL&quot;, &quot;\&quot;http://viewer.simlinux.com/k/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_PICTURE_URL&quot;, &quot;\&quot;http://img1.simlinux.com/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_RES_URL&quot;, &quot;\&quot;http://res.simlinux.com/\&quot;&quot;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        release &#123;</div><div class="line">            // 不显示Log</div><div class="line">            buildConfigField &quot;boolean&quot;, &quot;LOG_DEBUG&quot;, &quot;false&quot;</div><div class="line">            minifyEnabled true</div><div class="line">            zipAlignEnabled true</div><div class="line">            // 移除无用的resource文件</div><div class="line">            shrinkResources true</div><div class="line">            proguardFile &apos;proguard-project.txt&apos;</div><div class="line">            debuggable false</div><div class="line">            shrinkResources false</div><div class="line">            signingConfig signingConfigs.debug</div><div class="line">            manifestPlaceholders = [</div><div class="line">                    UMENG_APP_KEY   : &quot;556ac6s3162358e06c0000218&quot;,</div><div class="line">                    UMENG_APP_SECRET: &quot;2a231041d6aa10ec2b2s933003135a7&quot;</div><div class="line">            ]</div><div class="line">            //Server config</div><div class="line">            buildConfigField &quot;boolean&quot;, &quot;SELECT_SERVER&quot;, &quot;false&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_IP&quot;, &quot;\&quot;\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_PROJECT_URL&quot;, &quot;\&quot;\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_PICTURE_URL&quot;, &quot;\&quot;\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;TEST_RES_URL&quot;, &quot;\&quot;\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_IP&quot;, &quot;\&quot;http://api.simlinux.com/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_PROJECT_URL&quot;, &quot;\&quot;http://viewer.simlinux.com/k/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_PICTURE_URL&quot;, &quot;\&quot;http://img1.simlinux.com/\&quot;&quot;</div><div class="line">            buildConfigField &quot;String&quot;, &quot;FORMAL_RES_URL&quot;, &quot;\&quot;http://res.simlinux.com/\&quot;&quot;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    applicationVariants.all &#123; variant -&amp;gt;</div><div class="line">        variant.outputs.each &#123; output -&amp;gt;</div><div class="line">            def outputFile = output.outputFile</div><div class="line">            if (outputFile != null &amp;amp;&amp;amp; outputFile.name.endsWith(&apos;.apk&apos;)) &#123;</div><div class="line">                def fileName = outputFile.name.replace(&quot;.apk&quot;, &quot;-$&#123;defaultConfig.versionName&#125;.apk&quot;)</div><div class="line">                output.outputFile = new File(outputFile.parent, fileName)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    productFlavors &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">repositories &#123;</div><div class="line">    flatDir &#123;</div><div class="line">        dirs &apos;libs&apos; //this way we can find the .aar file in libs</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.google.code.gson:gson:2.3.1&apos;</div><div class="line">    compile &apos;com.github.japgolly.android:svg-android:2.0.6&apos;</div><div class="line">    compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div><div class="line">    compile &apos;com.android.support:appcompat-v7:22.2.0&apos;</div><div class="line">    compile &apos;com.github.rey5137:material:1.2.1&apos;</div><div class="line">    compile &apos;com.squareup.okhttp:okhttp-apache:2.4.0&apos;</div><div class="line">    compile(name: &apos;vds-sdk-release&apos;, ext: &apos;aar&apos;)</div><div class="line">    compile &apos;com.android.support:multidex:1.0.0&apos;</div><div class="line">    compile project(&apos;:PushSDK&apos;)</div><div class="line">    compile &apos;com.google.zxing:core:3.2.1&apos;</div><div class="line">    compile &apos;com.android.support:recyclerview-v7:24.0.0-alpha1&apos;</div><div class="line">    compile &apos;com.rengwuxian.materialedittext:library:2.1.4&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">匹配META-INF/channel_wandoujia文件名读取wandoujia渠道</div><div class="line"></div><div class="line">    public static String readChanel() &#123;</div><div class="line">        ApplicationInfo appInfo = ContextManager.getContext().getApplicationInfo();</div><div class="line">        String sourceDir = appInfo.sourceDir;</div><div class="line">        String ret = &quot;&quot;;</div><div class="line">        ZipFile zipfile = null;</div><div class="line">        Log.i(TAG, &quot;---begin-ret=&quot; + ret);</div><div class="line">        try &#123;</div><div class="line">            zipfile = new ZipFile(sourceDir);</div><div class="line">            Enumeration&amp;lt;?&amp;gt; entries = zipfile.entries();</div><div class="line">            while (entries.hasMoreElements()) &#123;</div><div class="line">                ZipEntry entry = ((ZipEntry) entries.nextElement());</div><div class="line">                String entryName = entry.getName();</div><div class="line">                if (entryName.startsWith(&quot;META-INF/channel&quot;)) &#123;</div><div class="line">                    ret = entryName;</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; finally &#123;</div><div class="line">            if (zipfile != null) &#123;</div><div class="line">                try &#123;</div><div class="line">                    zipfile.close();</div><div class="line">                &#125; catch (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h4 id="Android多渠道打包流程"><a href="#Android多渠道打包流程" class="headerlink" title="Android多渠道打包流程"></a>Android多渠道打包流程</h4><p>基于上述方式实现多渠道打包流程如下:</p>
<ul>
<li>执行gradlew clean清除build目录</li>
<li>执行gradlew assemble编译打包Debug/Release(已自动签名)</li>
<li>上传Debug包到Fir</li>
<li>通过DingTalk发送通知信息到QA讨论组(发送提测apk包版本，下载地址及扫描下载二维码)</li>
<li>提测不通过，修复bug后再次执行前四步</li>
<li>提测通过后，点击Jenkins打包归档多渠道按钮，将执行生成多渠道包并归档包到本地目录/data/2.0.1/xxx.apk</li>
<li>可选择此步上传归档文件到OSS</li>
<li>点击Jenkins发布按钮将最新版本相关渠道归档拷贝至OSS发布目录</li>
<li>刷新CDN生效</li>
<li>通过DingTalk发送通知信息到QA讨论组哪些渠道已经发布</li>
</ul>
<h4 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h4><h5 id="配置Jenkins"><a href="#配置Jenkins" class="headerlink" title="配置Jenkins"></a>配置Jenkins</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">插件: Dynamic Choice Parameter</div><div class="line">创建打包测试项目:Android-Test</div></pre></td></tr></table></figure>
<p><img src="http:///blog.simlinux.com/wp-content/uploads/2016/04/android-test.png" alt=""><br><img src="http://blog.simlinux.com/wp-content/uploads/2016/04/android-test-choice.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">通过Groovy脚本获取分支</div><div class="line">def ver_keys = [ &apos;bash&apos;, &apos;-c&apos;, &apos;cd /usr/share/tomcat/.jenkins/workspace/Android-Test;git branch -a|grep remotes|cut -d &quot;/&quot; -f3|grep -v HEAD|sort&apos; ]</div><div class="line">    ver_keys.execute().text.tokenize(&apos;\n&apos;)</div><div class="line"></div><div class="line">构建脚本</div><div class="line">#!/bin/bash</div><div class="line">PATH=/usr/lib64/qt-3.3/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/usr/local/jdk1.7.0_80/bin:/usr/local/android-sdk-linux/tools:/usr/local/android-sdk-linux/platform-tools:/usr/local/gradle-2.2.1/bin:/usr/share/tomcat/bin</div><div class="line"></div><div class="line">cd $&#123;WORKSPACE&#125;</div><div class="line">git checkout $&#123;BranchToDeploy&#125;</div><div class="line">git pull -f</div><div class="line"></div><div class="line">if [ &quot;$&#123;EnvToDeploy&#125;&quot;  = &quot;All Env&quot; ];then</div><div class="line"></div><div class="line">        $&#123;WORKSPACE&#125;/gradlew clean</div><div class="line">        $&#123;WORKSPACE&#125;/gradlew assemble</div><div class="line"></div><div class="line">else</div><div class="line">        $&#123;WORKSPACE&#125;/gradlew clean</div><div class="line">        $&#123;WORKSPACE&#125;/gradlew assemble$&#123;EnvToDeploy&#125;</div><div class="line"></div><div class="line">fi</div><div class="line">#测试包上传fir，发钉钉通知</div><div class="line">/usr/local/bin/python /usr/share/tomcat/AndroidDeploy/androidtest.py</div></pre></td></tr></table></figure>
<p><strong>创建多渠道包归档项目:Android-Archive</strong></p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/04/android-archive.png" alt=""><br><img src="http://blog.simlinux.com/wp-content/uploads/2016/04/android-archive-channel.png" alt=""></p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">获取channel列表</div><div class="line">def ver_keys = [ &apos;bash&apos;, &apos;-c&apos;, &apos;echo &quot;All Channels&quot;; cat /usr/share/tomcat/.jenkins/workspace/MAKA-Android-Testing/channels&apos; ]</div><div class="line">ver_keys.execute().text.tokenize(&apos;\n&apos;)</div><div class="line">构建脚本，更改渠道文件，上传OSS，发送钉钉通知</div><div class="line">python /usr/share/tomcat/AndroidDeploy/androidarchive.py</div></pre></td></tr></table></figure>
</code></pre><p><strong>创建发布多渠道包项目:Android-Deploy</strong></p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">构建脚本，通过OSS API拷贝要发布的归档渠道包到发布目录，发送钉钉通知</div><div class="line">python /usr/share/tomcat/AndroidDeploy/androiddeploy.py</div></pre></td></tr></table></figure>
</code></pre><h4 id="相关脚本"><a href="#相关脚本" class="headerlink" title="相关脚本"></a>相关脚本</h4><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">├── androidarchive.py       多渠道打包归档脚本</div><div class="line">├── androiddeploy.py        渠道包发布脚本</div><div class="line">├── androidtest.py          测试打包脚本</div><div class="line">└── libs</div><div class="line">    ├── chinanetcenter.py   刷新CDN脚本</div><div class="line">    ├── dingtalk.py         钉钉发送消息,图片，分享脚本</div><div class="line">    ├── fir.py              测试包上传fir脚本</div><div class="line">    ├── __init__.py</div><div class="line">    └── libsoss.py          oss相关操作脚本(上传，拷贝等)</div><div class="line"></div><div class="line">具体代码可根据https://github.com/geekwolf/AppDeployment按照实际业务进行修改</div></pre></td></tr></table></figure>
</code></pre><h4 id="IOS打包流程"><a href="#IOS打包流程" class="headerlink" title="IOS打包流程"></a>IOS打包流程</h4><ul>
<li>xcodebuild clean 清理build目录</li>
<li>xcodebuild archive 选择不同的环境/BundleID/ProvisionProfile/CodeSigningIdentify 编译，签名生成xcarchive文件放到工程根路径下的 build 文件夹里</li>
<li>xcodebuild -exportArchive 打包生成ipa</li>
<li>测试包自动上传Fir,生产包手动更新AppStore</li>
<li>具体可参考脚本 <a href="https://github.com/geekwolf/AppDeployment/blob/master/IOSDeploy.sh" target="_blank" rel="external">https://github.com/geekwolf/AppDeployment/blob/master/IOSDeploy.sh</a></li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>任何自动化的前提必须先规范化,针对Android多渠道打包渠道命名，apk包命名需要先统一，apk包不要多环境混用(生产环境和测试环境要分离,测试包可自定义切换)；到了这里，会发现我TM乱七八糟搞了这一陀哪里酸爽了？另外一个思路是通过修改apk文件的注释,程序在启动时读取apk文件注释获取渠道名(但是Android系统直到API 19，也就是4.4以上的版本才支持data/app/<package>.apk)<br><strong><em>爽在哪里？</em></strong><br> 1. 打包不再需要开发本地执行(避免中断开发,多人协作时优势更为明显)<br> 2. 多渠道打包时间在于第一个包编译生成和签名的时间,之后的无论多少渠道都只是修改包的META-INF/channel_wandoujia空文件名实现<br> 3. 点下Jenkins按钮无需在等待打包过程，打包完成后发送消息到钉钉会话，这下爽了吗？</package></p>
<h4 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h4><blockquote>
<p>Gradle入门  <a href="http://www.androidchina.net/2155.html" target="_blank" rel="external">http://www.androidchina.net/2155.html</a><br>Android签名 <a href="http://www.tuicool.com/articles/2eMZJfu" target="_blank" rel="external">http://www.tuicool.com/articles/2eMZJfu</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2016/03/16/startup-company-cicd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/16/startup-company-cicd.html" itemprop="url">初创公司应该如何做好持续集成和部署？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-16T19:11:45+08:00">
                2016-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CI-CD/" itemprop="url" rel="index">
                    <span itemprop="name">CI/CD</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/03/16/startup-company-cicd.html" class="leancloud_visitors" data-flag-title="初创公司应该如何做好持续集成和部署？">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>　　　 持续集成和部署是每一个互联网团队都必须要面对的问题，特别是初创公司业务和技术团队快速增长，技术积累较弱的情况下，一个高效的，可遵循持续的运维规范尤为重要，最近一段时间一直在梳理项目开发流程以及自动化测试和部署规范，作为一个总结和大家分享，希望有所帮助：<br>高效可持续的运维环境需要合理的规范作为支撑:</p>
<blockquote>
<ul>
<li>应用管理规范</li>
<li>权限管理规范</li>
<li>配置变更规范</li>
<li>发布策略规范</li>
<li>日志运维规范</li>
<li>持续集成部署实战</li>
</ul>
</blockquote>
<h3 id="应用管理规范"><a href="#应用管理规范" class="headerlink" title="应用管理规范"></a>应用管理规范</h3><h4 id="应用版本化"><a href="#应用版本化" class="headerlink" title="应用版本化"></a>应用版本化</h4><p>　　　 可以使用SVN,Git对代码进行版本控制，建议使用Git(GitLab)<br>　　　 项目Group命名规范: 按大的原则根据产品域名区分  或者根据前后端业务模块进行分组(小写字母命名,横杠[-]作为连接字符)<br>　　　 比如: MAKA官网<a href="http://www.maka.im对应的Git仓库Group为official" target="_blank" rel="external">http://www.maka.im对应的Git仓库Group为official</a><br>　　　 按照功能模块分组如商城前端对应的Git仓库Group为store<br>项目名命名规范: 小写字母命名,横杠[-]作为连接字符,命名规则[产品名称]-[项目类型]-(自定义名称),如official-store<br><strong>注:</strong> 在创建项目仓库时就要权衡前后端或者大的功能模块的拆分保持低耦合度</p>
<h4 id="合理的分支策略"><a href="#合理的分支策略" class="headerlink" title="合理的分支策略"></a>合理的分支策略</h4><p>常用的Git工作流：</p>
<p><strong>集中式工作流</strong>：很多公司使用SVN,Git使用并不熟悉,如果迁移至Git之后可以考虑集中式工作流进行开发，代码库只有master一个分支,所有开发者只有本地master和远端master分支，集中式工作流使用起来虽然简单，但无法充分利用git的优势<br><strong>功能分支工作流</strong>： 与集中式工作流不同的地方在于除了master分支以外有功能分支(按功能需求创建的功能分支如third-party-login-feature)，日常开发在功能分支,提测集成时提交Merge Requests(在Bitbucket中是Pull Request)，此处开发者可以进行讨论审核代码,同意后可以合并至master分支,未同意或者让开发者修改后重新提交可以选择关闭该MR</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/03/featurebranch.png" alt=""><br><strong>Gitflow工作流</strong>：两个主干分支master(正式发布的历史)和develop(功能集成分支)，开发者应基于develop分支创建feature功能分支用于开发,开发完成后提交merge requests请求合并进develop分支,此时若到了发布窗口,基于此时的develop分支创建发布分支release用于测试,预发布,发布以避免影响develop分支的正常集成合并功能分支；release分支不再有新的功能合并进来，一旦创建只用于bug修复并将修复cherry-pick到develop分支;发布完成后，release分支合并进master并分配版本号打tag用于存放发布历史;Gitflow工作流方式适用于大型项目<br><strong>Forking工作流</strong>：开发者fork官方的repo到自己的账号空间,对于官方分支只有只读权限，开发者通过pr提交给官方审核是否合并进代码库;开发者通过同步上游官方的repo来使用其他人的代码,分支策略可参考上述三种工作流,适合开源项目</p>
<p>　　　 针对创业公司参与同一个项目的开发者并不多,过于复杂的分支策略并不能带来便利;可以参考leancloud的分支模式,根据团队的使用情况进行调整</p>
<p><strong>介绍下我们当前使用的分支策略：</strong><br>　　　 master：主干分支master用于日常开发的基线<br>　　　 userA：   开发者A日常开发所在分支<br>　　　 release-201603091106: master分支集成测试完成后,构建到预发布环境时自动创建release-201603091106用于发布<br>　　　 hotfix-201603091106 基于当前发布之后的release-201603091106分支用于修复bug,在通过提交merge requests方式合并进release-201603091106，并将修复cherry-pick到master分支<br>　　　 日常开发在userA分支操作，然后提交merge requests请求合并至master分支,本地通过git fetch origin master，然后在userA分支git rebase origin/master将master最新commit合并到本地userA分支从而形成闭环开发</p>
<h4 id="关于代码审核"><a href="#关于代码审核" class="headerlink" title="关于代码审核"></a>关于代码审核</h4><p>　　　三剑客GitLab+Jenkins+Gerrit,Gerrit作为创业公司代码审核的话略显复杂，不足够敏捷;建议使用GitLab的Merge Requests或者Github和Bitbucket中Pull Requests作为代码审核和讨论的工具,也可以选择Facebook的Phabricator(可同时作为代码托管和评审,非常敏捷,由于Phabricator提供的工具集在windows下使用起来不太友好,后来没有选用,后期会分享Phabricator的使用思路和工作流)</p>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><p>　　　规范的目录结构不仅有利于开发者理解代码结构,更有利于代码的快速部署，以PHP为例目录结构建议将代码配置文件(数据库，Redis，OSS Key，语言开关，日志级别开关等),日志文件,其他文件缓存等独立于代码库之外存放，前端项目src为源码目录,dist为前端经过压缩合并等最终生成的代码目录(发布时可忽略src);<br>　　　每个项目详细写README.md:项目说明,各个环境对应的访问路径,目录说明,构建压缩方式,Nginx配置等,代码仓库中包含额外的test目录存放测试用例(本着谁开发谁写测试用例);</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/03/tree.png" alt=""></p>
<h3 id="权限管理规范"><a href="#权限管理规范" class="headerlink" title="权限管理规范"></a>权限管理规范</h3><p>　　　权限有两类一个是系统权限(包括服务器登陆，数据库/Redis等)另外一个是服务运行时的权限;</p>
<h4 id="针对系统权限层面"><a href="#针对系统权限层面" class="headerlink" title="针对系统权限层面"></a>针对系统权限层面</h4><p>　　　统一入口，受限访问IP，禁止空密码弱口令，生产环境服务器需要先拨入vpn之后通过跳板机才能连接成功（当然我们使用的是开源当中最好的跳板机Jumpserver），任何人的操作都需要审计;生产数据库及Redis禁止了外网访问,分别使用phpMyAdmin和RedisLive统一访问入口(增加了多主机访问及屏蔽了危险操作如DDL 数据的导入导出等，也需要先拨入vpn才能访问);</p>
<p>　　　开发测试环境权限控制现对宽松,DEV Leader和QA Leader同时具有开发和测试环境的服务器及数据库权限，便于测试和Debug;生产环境为了便于开发调试生产代码且不影响线上增加了低配的节点，未在线，但环境，代码及后端均和生产一致;</p>
<h4 id="针对服务权限层面"><a href="#针对服务权限层面" class="headerlink" title="针对服务权限层面"></a>针对服务权限层面</h4><p>　　　以web服务为例:Nginx和php-fpm运行用户和用户组为www-data,代码目录用户为www,这样代码目录默认情况下web服务只读,避免出现文件和目录777权限的情况；日志和缓存目录用户设置www-data，但要禁止访问php等动态文件</p>
<p>　　　禁止危险函数phpinfo exec eval system等,具体可参考<a href="http://www.sinacloud.com/doc/sae/php/runtime.html,禁止夸目录访问open_basedir，是否开启的性能对比请参考http://blog.simlinux.com/archives/1531.html" target="_blank" rel="external">http://www.sinacloud.com/doc/sae/php/runtime.html,禁止夸目录访问open_basedir，是否开启的性能对比请参考http://blog.simlinux.com/archives/1531.html</a></p>
<h3 id="配置变更规范"><a href="#配置变更规范" class="headerlink" title="配置变更规范"></a>配置变更规范</h3><h4 id="系统部署"><a href="#系统部署" class="headerlink" title="系统部署"></a>系统部署</h4><p>　　　传统IDC机房可以通过定制镜像或者使用cobbler定制安装，运行的服务也可以定制在镜像中,但建议安装系统时注册puppet/salt agent，再自动化署相关服务<br>　　　公有云中可以在服务器上部署相应环境后创建系统快照制作系统镜像,弹性扩容时可选择该镜像自动化安装   </p>
<h4 id="日常变更"><a href="#日常变更" class="headerlink" title="日常变更"></a>日常变更</h4><p>　　   日常变更包括服务配置的变更和代码配置的变更,这些操作我们是通过Ansible(对比puppet/salt的好处就是简单方便不用装agent，后面会详细介绍如何基于Ansible做发布回滚)，变更内容使用git进行版本控制制</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/03/ansible-dire.png" alt=""></p>
<h3 id="发布策略规范"><a href="#发布策略规范" class="headerlink" title="发布策略规范"></a>发布策略规范</h3><h4 id="发布时间"><a href="#发布时间" class="headerlink" title="发布时间"></a>发布时间</h4><p><img src="http://blog.simlinux.com/wp-content/uploads/2016/03/deploytime.jpg" alt=""></p>
<p><strong>注意:</strong>以上请根据自己业务做相应调整,避免在业务高峰期发布(除应急bug外),我们业务高峰期基本在18:00-23:30，低峰期基本在01:00-06:00,这也是微信分享阅读的高峰和低峰时段;无论应急Bug还是日常迭代都必须由QA测试通过和产品经理审核通过后才能上线(曾经出现过开发为了修复线上很急的bug,开发修复后自主上线导致生产出现更严重的问题)</p>
<h4 id="发布工具的选择"><a href="#发布工具的选择" class="headerlink" title="发布工具的选择"></a>发布工具的选择</h4><p>　　　 无论是自主开发发布系统亦或是使用开源的系统都要本着解决问题的原则,否则只能是重复造轮子,然并卵呀<br>　　　 开源的持续集成和发布里面个人觉得比较好的如:Jenkins,Walle,Spinnaker，go，Gitlab-ci，Bamboo(收费)等，其他参考<a href="https://github.com/geekwolf/sa-scripts/blob/master/devops.md" target="_blank" rel="external">https://github.com/geekwolf/sa-scripts/blob/master/devops.md</a><br>　　　 下面介绍我们基于GitLab+Jenkins+Ansible(Flamingo自动化代码发布工具)实现的自动化代码部署平台，流程如下:</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/03/cicdflow.png" alt=""></p>
<p>　　　<strong>Flamingo</strong>(“火烈鸟”,<a href="https://github.com/geekwolf/flamingo)是基于Ansible的自动化代码发布工具，目的是实现统一的代码发布方式,思路基于Capistrano,并对Ansisrano进行了改造可以通过传入语言环境,主机组(应用组/灰度机组等),项目代码库,分支名称,项目名称等参数来进行自动化打包发布,也可以将Flamingo工具二次打包使用" target="_blank" rel="external">https://github.com/geekwolf/flamingo)是基于Ansible的自动化代码发布工具，目的是实现统一的代码发布方式,思路基于Capistrano,并对Ansisrano进行了改造可以通过传入语言环境,主机组(应用组/灰度机组等),项目代码库,分支名称,项目名称等参数来进行自动化打包发布,也可以将Flamingo工具二次打包使用</a><br>　　　<strong>Flamingo</strong>本者回滚即发布的原则以简化发布流程，回滚时传入要回滚的分支即可，其他参数可参看defaults/main.yml进行了解;(注:依赖Git/rsync/ansible)<br>　　　 例子:</p>
<pre><code>ansible-playbook deploy.yml  --extra-vars=&apos;flamingo_git_repo=git@github.com:geekwolf/flamingo.git flamingo_product_name=flamingo&apos;
</code></pre><p>　　　 执行后生成的目录结构如下图(目录定义请参考defaults/main.yml):</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2016/03/deploymentdire.jpg" alt=""></p>
<h3 id="日志运维规范"><a href="#日志运维规范" class="headerlink" title="日志运维规范"></a>日志运维规范</h3><p>　　　 毫无疑问规范的日志对于运维和开发排查问题有非常大的帮助，例如PHP项目日志格式可以规范为时间,日志级别,日志内容(比如对于连接多个DB时出现连接不上或超时应该把实例地址一同写入日志)，可以参考psr-3的标准: <a href="http://www.php-config.org/psr/psr-3" target="_blank" rel="external">http://www.php-config.org/psr/psr-3</a><br>　　　 通过ELK将业务日志,PHP自身错误日志/慢日志,Nginx慢日志等进行搜集统计并结合Zabbix实现报警,便于及早发现问题</p>
<h3 id="持续集成部署实战"><a href="#持续集成部署实战" class="headerlink" title="持续集成部署实战"></a>持续集成部署实战</h3><p>　　　 后续篇章会分享针对PHP/JAVA/前端以及Android/ios持续集成和部署实战,敬请关注</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>　　　 以上只是粗略对持续集成和部署过程中遇到的问题进行了总结，可能并不完美，但对于初创公司应该有些帮助,欢迎一起学习讨论！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.simlinux.com/2015/12/14/php-openbasedir.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Geekwolf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geekwolf's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/14/php-openbasedir.html" itemprop="url"> 记一次Web服务器lstat系统调用严重故障分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-12-14T14:58:07+08:00">
                2015-12-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux运维/" itemprop="url" rel="index">
                    <span itemprop="name">Linux运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2015/12/14/php-openbasedir.html" class="leancloud_visitors" data-flag-title=" 记一次Web服务器lstat系统调用严重故障分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Centos6.5 x64</div><div class="line">Tengine-2.1.0</div><div class="line">PHP-5.5.30</div></pre></td></tr></table></figure>
<p>随着业务流量增加,根据监控发现系统%sys的CPU占用率一度超过40%~50%(业务高峰期更为严重),<br>由于系统跑的是PHP,Nginx服务没有其它额外服务,PHP又容易成为系统的瓶颈，故使用strace跟踪了php-fpm进程的调用,如图:</p>
<h4 id="看现象"><a href="#看现象" class="headerlink" title="看现象"></a>看现象</h4><p>通过top命令查看实时状态,%sys内核态CPU占比非常高,负载较高</p>
<p><img src="http://blog.simlinux.com/wp-content/uploads/2015/12/te.jpg" alt=""></p>
<p>通过strace跟踪php-fpm进程运行时的系统调用 strace -c -p $(pgrep -n php-fpm)<img src="http://blog.simlinux.com/wp-content/uploads/2015/12/lstat.jpg" alt=""></p>
<p>lstat调用到底干什么的呢？<a href="http://blog.simlinux.com/wp-content/uploads/2015/12/manlstat.jpg" target="_blank" rel="external"><img src="http://blog.simlinux.com/wp-content/uploads/2015/12/manlstat.jpg" alt="manlstat"></a><br><a href="http://blog.simlinux.com/wp-content/uploads/2015/12/manlstat.jpg" target="_blank" rel="external"><img src="http://blog.simlinux.com/wp-content/uploads/2015/12/manlstat-1024x400.jpg" alt="manlstat"></a><a href="http://blog.simlinux.com/wp-content/uploads/2015/12/te.jpg" target="_blank" rel="external"><img src="http://blog.simlinux.com/wp-content/uploads/2015/12/te.jpg" alt="te"></a></p>
<h4 id="分析问题"><a href="#分析问题" class="headerlink" title="分析问题"></a>分析问题</h4><p>根据上面的现象可以看到lstat调用占用绝大部份的内核态CPU时间，可以通过strace跟踪php-fpm详细的lstat调用规律<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">strace  -o strace.out -r -s 256 $(pgrep -n php-fpm)</div><div class="line">    0.000051 getcwd(&quot;/data/wwwroot/run/platv3/public&quot;, 4096) = 43</div><div class="line">     0.000037 lstat(&quot;/data/wwwroot/run/platv3/public/../application/config/production/frontend_config.php&quot;, 0x7fffbe160260) = -1 ENOENT (No such file or directory)</div><div class="line">     0.000055 lstat(&quot;/data/wwwroot/run/platv3/public/../application/config/production&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000058 lstat(&quot;/data/wwwroot/run/platv3/public/../application/config&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000054 lstat(&quot;/data/wwwroot/run/platv3/public/../application&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000052 lstat(&quot;/data/wwwroot/run/platv3/public&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000050 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000058 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000043 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data/wwwroot/run/platv3/application/config/production/frontend_config.php&quot;, 0x7fffbe160270) = -1 ENOENT (No such file or directory)</div><div class="line">     0.000050 readlink(&quot;/data/wwwroot/run/platv3/application/config/production/frontend_config.php&quot;, 0x7fffbe162410, 4095) = -1 ENOENT (No such file or directory)</div><div class="line">     0.000077 lstat(&quot;/data/wwwroot/run/platv3/application/config/production&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000059 lstat(&quot;/data/wwwroot/run/platv3/application/config&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000052 lstat(&quot;/data/wwwroot/run/platv3/application&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000050 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000047 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000070 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000047 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000044 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 access(&quot;../application/config/production/frontend_config.php&quot;, F_OK) = -1 ENOENT (No such file or directory)</div><div class="line">     0.000051 getcwd(&quot;/data/wwwroot/run/platv3/public&quot;, 4096) = 43</div><div class="line">     0.000038 getcwd(&quot;/data/wwwroot/run/platv3/public&quot;, 4096) = 43</div><div class="line">     0.000036 lstat(&quot;/data/wwwroot/run/platv3/public/../application/config/frontend_config.php&quot;, &#123;st_mode=S_IFREG|0775, st_size=1556, ...&#125;) = 0</div><div class="line">     0.000069 lstat(&quot;/data/wwwroot/run/platv3/public/../application/config&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000057 lstat(&quot;/data/wwwroot/run/platv3/public/../application&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000053 lstat(&quot;/data/wwwroot/run/platv3/public&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000052 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000049 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000075 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data/wwwroot/run/platv3/application/config/frontend_config.php&quot;, &#123;stG|0775, st_size=9882, ...&#125;) = 0</div><div class="line">     0.000056 lstat(&quot;/data/wwwroot/run/platv3/application/libraries&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000052 lstat(&quot;/data/wwwroot/run/platv3/application&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000049 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000048 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000043 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000043 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000111 access(&quot;../application/libraries/X_Session.php&quot;, F_OK) = 0</div><div class="line">     0.000071 getcwd(&quot;/data/wwwroot/run/platv3/public&quot;, 4096) = 43</div><div class="line">     0.000043 lstat(&quot;/data/wwwroot/run/platv3/system/libraries/Session.php&quot;, &#123;st_mode=S_IFREG|0775, st_size=19266, ...&#125;) = 0</div><div class="line">     0.000060 lstat(&quot;/data/wwwroot/run/platv3/system/libraries&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000051 lstat(&quot;/data/wwwroot/run/platv3/system&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000050 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000049 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000055 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data/wwwroot/run/platv3/system/libraries/Session.php&quot;, &#123;st_mode=S_IFREG|0775, st_size=19266, ...&#125;) = 0</div><div class="line">     0.000055 lstat(&quot;/data/wwwroot/run/platv3/system/libraries&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000053 lstat(&quot;/data/wwwroot/run/platv3/system&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000052 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000053 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000047 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000051 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000047 lstat(&quot;/data/wwwroot/run/platv3/public&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000058 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000114 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000048 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000043 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data/wwwroot/run/platv3/system/libraries/Session.php&quot;, &#123;st_mode=S_IFREG|0775, st_size=19266, ...&#125;) = 0</div><div class="line">     0.000055 lstat(&quot;/data/wwwroot/run/platv3/system/libraries&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000052 lstat(&quot;/data/wwwroot/run/platv3/system&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000050 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000061 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000051 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000044 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data/wwwroot/run/platv3/system/libraries/Session.php&quot;, &#123;st_mode=S_IFREG|0775, st_size=19266, ...&#125;) = 0</div><div class="line">     0.000055 lstat(&quot;/data/wwwroot/run/platv3/system/libraries&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000053 lstat(&quot;/data/wwwroot/run/platv3/system&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000049 lstat(&quot;/data/wwwroot/run/platv3&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000050 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000046 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000045 lstat(&quot;/data/wwwroot/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000120 lstat(&quot;/data/wwwroot&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div><div class="line">     0.000055 lstat(&quot;/data&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</div></pre></td></tr></table></figure></p>
<p>由上面的信息不难看到程序在使用include,require,require_once,include_once,fopen,gzopen等开启了open_basedir之后,lstat调用会递归访问的文件目录查看文件位置限制，文件在open_basedir指定的目录以外时将拒绝打开,所有符号链接也会被解析无法避免此限制 ,这样就导致了lstat()调用比不开启open_basedir调用频率高很多;另外include,require,require_once,include_once在包含相对路径时,如果代码中存在大量的这样的语句,每次都从include_path中查找相应的文件,也会造成性能问题,所以通常用 realpath_cache_size 和realpath_cache_ttl来对文件的realpath进行缓存,但是开启了open_basedir之后,这个缓存是失效的;查看了官方的bug：<a href="https://bugs.php.net/bug.php?id=52312" target="_blank" rel="external">https://bugs.php.net/bug.php?id=52312</a> 有记录并没有修复,估计是考虑到安全问题</p>
<h4 id="验证问题"><a href="#验证问题" class="headerlink" title="验证问题"></a>验证问题</h4><p>大概了解了问题原因之后,对症下药来做测试,按三种情况测试下性能：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">1.开启open_basedir</div><div class="line">Disable PHP&apos;s open_basedir directive so that the realpath cache won&apos;t be</div><div class="line">; disabled.</div><div class="line">; Remember, turbo_realpath will set this option later to the</div><div class="line">; realpath_cache_basedir value.</div><div class="line">open_basedir = &quot;/data/wwwroot/run/:/tmp/&quot;</div><div class="line"></div><div class="line">2.使用realpath_turbo进行优化,开启open_basedir时,依然可以使用realpath cache;</div><div class="line">安装realpath_turbo扩展https://github.com/Whissi/realpath_turbo,修改php.ini</div><div class="line">#you have to load the extension first</div><div class="line">extension=turbo_realpath.so</div><div class="line">; realpath_turbo security mode</div><div class="line">; Possible values:</div><div class="line">;   0 - Ignore potential security issues</div><div class="line">;   1 - Disable dangerous PHP functions (link,symlink)</div><div class="line">realpath_cache_security = 1</div><div class="line"></div><div class="line">; Set realpath_cache_basedir to whatever you want to set open_basedir to</div><div class="line">realpath_cache_basedir = &quot;/data/wwwroot/run/:/tmp/&quot;</div><div class="line"></div><div class="line">; Disable PHP&apos;s open_basedir directive so that the realpath cache won&apos;t be</div><div class="line">; disabled.</div><div class="line">; Remember, turbo_realpath will set this option later to the</div><div class="line">; realpath_cache_basedir value.</div><div class="line">open_basedir = &quot;&quot;</div><div class="line"></div><div class="line">realpath_cache_size = 20m</div><div class="line">; Duration of time, in seconds for which to cache realpath information for a given</div><div class="line">; file or directory. For systems with rarely changing files, consider increasing this</div><div class="line">; value.</div><div class="line">; http://php.net/realpath-cache-ttl</div><div class="line">realpath_cache_ttl = 43200</div><div class="line"></div><div class="line">注意事项：使用realpath_turbo时,要关闭创建和操作符号链接的函数，否则会绕过 open_basedir安全限制,但依然不推荐在多虚拟主机环境使用</div><div class="line"></div><div class="line">3.关闭open_basedir,增加realpath缓存</div><div class="line">realpath_cache_size = 20m</div><div class="line">; Duration of time, in seconds for which to cache realpath information for a given</div><div class="line">; file or directory. For systems with rarely changing files, consider increasing this</div><div class="line">; value.</div><div class="line">; http://php.net/realpath-cache-ttl</div><div class="line">realpath_cache_ttl = 43200</div></pre></td></tr></table></figure></p>
<p>写脚本分别采集三种环境下系统调用占CPU时间百分比(采集半小时)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#*_* coding:utf-8 *_*</div><div class="line">import time</div><div class="line">import psutil</div><div class="line">import os</div><div class="line">end=1</div><div class="line">f = open(&apos;openbasedir.log&apos;,mode=&apos;w&apos;)</div><div class="line">f.write(&quot;%s\t\t%s\t\t\t%s\t\t%s\t\t%s&quot; % (&apos;id&apos;,&apos;time&apos;,&apos;sys_percent&apos;,&apos;hi&apos;,&apos;si&apos;) + &quot;\n&quot;)</div><div class="line">while end &gt;= 1800:</div><div class="line">    nowtime=time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;,time.localtime(time.time()))</div><div class="line">    ps = psutil.cpu_times_percent(interval=1)</div><div class="line">    data=&quot;%s\t\t%s\t\t%s\t\t%s\t\t%s&quot; % (end,nowtime,ps.system,ps.irq,ps.softirq)</div><div class="line">    f.write(data+os.linesep)</div><div class="line">    end +=1</div><div class="line">最终性能对比结果如图(横轴为采样id(s),纵轴为%sys占CPU时间比):</div></pre></td></tr></table></figure></p>
<p><a href="http://blog.simlinux.com/wp-content/uploads/2015/12/tongji.jpg" target="_blank" rel="external"><img src="http://blog.simlinux.com/wp-content/uploads/2015/12/tongji.jpg" alt="tongji"></a></p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>为了性能暂时关闭了open_basedir参数,开启realpath cache缓存,代码尽量少用include,require,include_once,require_once等</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ow1schdt5.bkt.clouddn.com/logo/wolf.jpeg"
               alt="Geekwolf" />
          <p class="site-author-name" itemprop="name">Geekwolf</p>
           
              <p class="site-description motion-element" itemprop="description">DevOps | Docker | Python | k8s</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">82</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">59</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/geekwolf" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/geekwolf" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.simlinux.com" title="旧版博客" target="_blank">旧版博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://nolinux.blog.51cto.com" title="nolinux" target="_blank">nolinux</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://xiaorui.cc" title="峰云就她了" target="_blank">峰云就她了</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://note.gitcloud.cc/blog/bluetom520" title="懒懒的天空" target="_blank">懒懒的天空</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.roddypy.com" title="普拉多VX" target="_blank">普拉多VX</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2012 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Geekwolf</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("qms5kJ0y2CItrIVFivKxxPsR-gzGzoHsz", "Cn3w20futtphxpaDSP5tHjzy");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
